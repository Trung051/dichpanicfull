<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Công Cụ Phân Tích Panic Log iOS - AI Vision Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .header h1 {
            font-size: 3em;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }
        
        .ai-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin: 0 10px;
            animation: pulse 2s infinite;
            box-shadow: 0 10px 20px rgba(255, 107, 107, 0.3);
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        .upload-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            transition: transform 0.3s ease;
        }
        
        .upload-section:hover {
            transform: translateY(-5px);
        }
        
        .upload-zone {
            border: 3px dashed #667eea;
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9ff, #fff5f8);
        }
        
        .upload-zone:hover {
            background: linear-gradient(135deg, #e6fffa, #f0fff4);
            border-color: #38a169;
            transform: scale(1.02);
        }
        
        .image-upload-zone {
            border: 3px dashed #f093fb;
            border-radius: 20px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #fff0fd, #fdf2f8);
        }
        
        .image-upload-zone:hover {
            background: linear-gradient(135deg, #fdf2f8, #fef7ff);
            border-color: #e879f9;
            transform: scale(1.02);
            box-shadow: 0 0 30px rgba(240, 147, 251, 0.3);
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 18px 35px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: all 0.3s ease;
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.5);
        }
        
        .ai-btn {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            box-shadow: 0 15px 30px rgba(240, 147, 251, 0.4);
        }
        
        .search-box {
            width: 100%;
            padding: 18px 25px;
            border: 2px solid #e2e8f0;
            border-radius: 30px;
            font-size: 1.1em;
            margin-bottom: 25px;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9ff, #fff5f8);
        }
        
        .search-box:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }
        
        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 25px 0;
        }
        
        .category-btn {
            background: linear-gradient(135deg, #f7fafc, #edf2f7);
            color: #4a5568;
            border: 2px solid #e2e8f0;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }
        
        .category-btn:hover, .category-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }
        
        .error-database {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            padding: 25px;
            background: linear-gradient(135deg, #f8f9ff, #fff5f8);
        }
        
        .error-item {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: all 0.3s ease;
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .error-item:hover {
            background: linear-gradient(135deg, #e6fffa, #f0fff4);
            transform: translateX(10px);
        }
        
        .results-container {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(20px);
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.15);
            display: none;
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .panic-analysis {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            border-left: 5px solid #e53e3e;
            padding: 30px;
            margin: 25px 0;
            border-radius: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .panic-analysis::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #e53e3e, #fc8181, #feb2b2);
        }
        
        .error-category {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .severity-indicator {
            display: inline-block;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin-right: 15px;
        }
        
        .severity-critical { background: #e53e3e; }
        .severity-high { background: #dd6b20; }
        .severity-medium { background: #d69e2e; }
        .severity-low { background: #38a169; }
        
        .ai-processing {
            display: none;
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f0fff4, #c6f6d5);
            border-radius: 20px;
            margin: 20px 0;
        }
        
        .ai-spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        
        .confidence-meter {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .confidence-bar {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }
        
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #38a169, #48bb78);
            border-radius: 4px;
            transition: width 1s ease;
        }
        
        .floating-action {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            z-index: 1000;
        }
        
        .floating-action:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(102, 126, 234, 0.5);
        }

        /* Responsive Design cho Mobile */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }
            
            .container {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            /* Mobile Layout */
            .main-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 20px 15px;
                margin-bottom: 20px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
                margin-bottom: 10px;
            }
            
            .header p {
                font-size: 1em !important;
                margin: 10px 0 !important;
            }
            
            /* Upload sections mobile */
            .upload-section {
                padding: 20px 15px;
                border-radius: 15px;
            }
            
            .upload-zone, .image-upload-zone {
                padding: 30px 15px;
                border-radius: 15px;
            }
            
            .upload-zone div[style*="font-size: 3em"], 
            .image-upload-zone div[style*="font-size: 3em"] {
                font-size: 2em !important;
                margin-bottom: 10px !important;
            }
            
            .upload-zone h4, .image-upload-zone h4 {
                font-size: 1.1em;
                margin-bottom: 8px;
            }
            
            .upload-zone p, .image-upload-zone p {
                font-size: 0.9em;
                margin: 8px 0 !important;
            }
            
            /* Buttons mobile */
            .btn {
                padding: 14px 25px;
                font-size: 1em;
                border-radius: 25px;
                width: 100%;
                max-width: 200px;
            }
            
            /* Search box mobile */
            .search-box {
                padding: 15px 20px;
                font-size: 1em;
                margin-bottom: 20px;
                border-radius: 25px;
            }
            
            /* Category filter mobile */
            .category-filter {
                gap: 10px;
                margin: 20px 0;
                justify-content: center;
            }
            
            .category-btn {
                padding: 10px 15px;
                font-size: 0.9em;
                border-radius: 20px;
                flex: 1;
                min-width: auto;
                text-align: center;
            }
            
            /* Error database mobile */
            .error-database {
                max-height: 400px;
                padding: 15px;
                border-radius: 15px;
            }
            
            .error-item {
                padding: 12px;
                margin-bottom: 8px;
                border-radius: 8px;
            }
            
            /* Results container mobile */
            .results-container {
                padding: 20px 15px;
                border-radius: 15px;
            }
            
            .panic-analysis {
                padding: 20px 15px;
                margin: 15px 0;
                border-radius: 15px;
            }
            
            /* Stats grid mobile */
            .upload-section div[style*="display: grid; grid-template-columns: 1fr 1fr"] {
                gap: 10px !important;
            }
            
            .upload-section div[style*="text-align: center; padding: 15px"] {
                padding: 12px !important;
                border-radius: 10px !important;
            }
            
            .upload-section div[style*="font-size: 1.8em"] {
                font-size: 1.5em !important;
            }
            
            .upload-section div[style*="font-size: 0.9em"] {
                font-size: 0.8em !important;
            }
            
            /* Floating action button mobile */
            .floating-action {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
                font-size: 20px;
            }
            
            /* AI Processing mobile */
            .ai-processing {
                padding: 20px 15px;
                border-radius: 15px;
                margin: 15px 0;
            }
            
            .ai-spinner {
                width: 40px;
                height: 40px;
                margin: 15px auto;
            }
        }

        @media (max-width: 480px) {
            /* Extra small mobile */
            .container {
                padding: 8px;
            }
            
            .header {
                padding: 15px 12px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 1.5em;
            }
            
            .header p {
                font-size: 0.9em !important;
            }
            
            .upload-section {
                padding: 15px 12px;
            }
            
            .upload-zone, .image-upload-zone {
                padding: 25px 12px;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 0.95em;
            }
            
            .search-box {
                padding: 12px 18px;
                font-size: 0.95em;
            }
            
            .category-btn {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            
            .error-database {
                padding: 12px;
                max-height: 350px;
            }
            
            .results-container {
                padding: 15px 12px;
            }
            
            .panic-analysis {
                padding: 15px 12px;
            }
            
            .floating-action {
                width: 45px;
                height: 45px;
                bottom: 15px;
                right: 15px;
                font-size: 18px;
            }
        }

        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            /* Touch devices */
            .btn, .category-btn, .error-item, .floating-action {
                min-height: 44px; /* Apple's recommended touch target size */
            }
            
            .upload-zone, .image-upload-zone {
                min-height: 120px;
            }
            
            .search-box {
                min-height: 44px;
            }
            
            /* Remove hover effects on touch devices */
            .upload-section:hover {
                transform: none;
            }
            
            .upload-zone:hover, .image-upload-zone:hover {
                transform: none;
                box-shadow: none;
            }
            
            .btn:hover {
                transform: none;
                box-shadow: 0 15px 30px rgba(102, 126, 234, 0.4);
            }
            
            .category-btn:hover {
                transform: none;
            }
            
            .error-item:hover {
                transform: none;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }
            
            .header {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.6em;
            }
            
            .upload-zone, .image-upload-zone {
                padding: 20px 15px;
            }
        }

        /* Dark mode support for mobile */
        @media (prefers-color-scheme: dark) {
            .search-box {
                background: linear-gradient(135deg, #2d3748, #4a5568);
                color: white;
                border-color: #4a5568;
            }
            
            .error-database {
                background: linear-gradient(135deg, #2d3748, #4a5568);
            }
            
            .error-item {
                color: #e2e8f0;
            }
        }

        /* Reduce motion for accessibility */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
            
            .shimmer, .scan-line, .floating-particles {
                display: none;
            }
        }

        /* Additional mobile-specific styles */
        @keyframes float {
            0%, 100% { 
                transform: translateY(0px) rotate(0deg); 
                opacity: 0.7;
            }
            50% { 
                transform: translateY(-20px) rotate(180deg); 
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        .scan-line {
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.3), transparent);
            animation: scanEffect 2s infinite;
        }
        
        @keyframes scanEffect {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        
        .error-item.selected {
            background: linear-gradient(135deg, #e6fffa, #b2f5ea) !important;
            border-left: 5px solid #38b2ac !important;
            transform: translateX(10px) !important;
        }
        
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            animation: float 6s ease-in-out infinite;
        }
        
        /* Mobile optimizations */
        @media (max-width: 768px) {
            .scan-line {
                animation: scanEffect 3s infinite; /* Slower on mobile */
            }
            
            .particle {
                animation: float 8s ease-in-out infinite; /* Slower on mobile */
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }
        
        /* Focus styles for accessibility */
        button:focus,
        input:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        
        /* Loading animation */
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>dịch Panicfull</h1>
            <p style="font-size: 1.2em; margin: 15px 0;">AI Vision + 100+ Cơ Sở Dữ Liệu Lỗi + Phân Tích Thời Gian Thực</p>
        </div>
        
        <div class="main-grid">
            <!-- Upload File Text -->
            <div class="upload-section">
                <h3 style="margin-bottom: 20px;">📄 File Text/Log</h3>
                <div class="upload-zone" id="textUploadZone">
                    <input type="file" id="textFileInput" style="display: none" accept=".txt,.crash,.ips,.panic-full,.log" multiple>
                    <div style="font-size: 3em; margin-bottom: 15px;">📱</div>
                    <h4>Kéo Thả File Log</h4>
                    <p style="margin: 10px 0; color: #666;">Hỗ trợ: txt, crash, ips, panic-full, log</p>
                    <button class="btn" onclick="document.getElementById('textFileInput').click()">Chọn File</button>
                </div>
                
                <div style="margin-top: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: #f0fff4; border-radius: 15px;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #38a169;" id="textFiles">0</div>
                            <div style="font-size: 0.9em; color: #666;">File Text</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #fff5f5; border-radius: 15px;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #e53e3e;" id="textErrors">0</div>
                            <div style="font-size: 0.9em; color: #666;">Lỗi Tìm Thấy</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Upload Ảnh với AI Vision -->
            <div class="upload-section">
                <h3 style="margin-bottom: 20px;">📸 Phân Tích AI Vision</h3>
                <div class="image-upload-zone" id="imageUploadZone">
                    <input type="file" id="imageFileInput" style="display: none" accept="image/*" multiple>
                    <div style="font-size: 3em; margin-bottom: 15px;">🤖👁️</div>
                    <h4>Nhận Dạng Ảnh AI</h4>
                    <p style="margin: 10px 0; color: #666;">jpg, png, heic, webp</p>
                    <button class="btn ai-btn" onclick="document.getElementById('imageFileInput').click()">Tải Ảnh Lên</button>
                </div>
                
                <div class="ai-processing" id="aiProcessing">
                    <div class="ai-spinner"></div>
                    <h4>🧠 AI Đang Xử Lý...</h4>
                    <p>Phân tích ảnh với OCR + Nhận dạng mẫu nâng cao</p>
                </div>
                
                <div style="margin-top: 25px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div style="text-align: center; padding: 15px; background: #fdf2f8; border-radius: 15px;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #f093fb;" id="imageFiles">0</div>
                            <div style="font-size: 0.9em; color: #666;">Ảnh</div>
                        </div>
                        <div style="text-align: center; padding: 15px; background: #f0f9ff; border-radius: 15px;">
                            <div style="font-size: 1.8em; font-weight: bold; color: #3b82f6;" id="aiAccuracy">0%</div>
                            <div style="font-size: 0.9em; color: #666;">Độ Chính Xác AI</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tìm Kiếm Thông Minh -->
            <div class="upload-section">
                <h3 style="margin-bottom: 20px;">🔍 Tìm Kiếm Lỗi Thông Minh</h3>
                <input type="text" class="search-box" id="searchBox" placeholder="Tìm kiếm 100+ lỗi (watchdog, thermal, panic...)">
                
                <div class="category-filter">
                    <div class="category-btn active" onclick="filterByCategory('all')">Tất Cả</div>
                                        <div class="category-btn" onclick="filterByCategory('hardware')">Phần Cứng</div>
                    <div class="category-btn" onclick="filterByCategory('software')">Phần Mềm</div>
                    <div class="category-btn" onclick="filterByCategory('thermal')">Nhiệt Độ</div>
                    <div class="category-btn" onclick="filterByCategory('power')">Nguồn</div>
                    <div class="category-btn" onclick="filterByCategory('memory')">Bộ Nhớ</div>
                </div>
                
                <div class="error-database" id="errorDatabase">
                    <div style="text-align: center; color: #666; padding: 30px;">
                        <div style="font-size: 2em; margin-bottom: 10px;">🤖</div>
                        <p>AI sẵn sàng phân tích 100+ mẫu lỗi</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="results-container" id="resultsContainer">
            <h3 style="margin-bottom: 30px;">📊 Kết Quả Phân Tích AI</h3>
            <div id="analysisResults"></div>
        </div>
    </div>

    <script>
        // Mobile detection và optimization
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isTouch = 'ontouchstart' in window;

        // Cơ sở dữ liệu 100+ lỗi iOS panic log
        const errorDatabase = {
            // === LỖI PHẦN CỨNG CHI TIẾT ===
            
            "watchdog_timeout": {
                category: "hardware",
                severity: "critical",
                description: "Lỗi Watchdog timeout - CPU hoặc hệ thống không phản hồi trong thời gian quy định",
                patterns: ["watchdog timeout", "WDOG", "no checkin", "hang", "watchdog_timeout"],
                vietnameseName: "Lỗi Watchdog Timeout",
                component: "Main Logic Board - CPU/SoC",
                location: "A-series Processor (A12/A13/A14/A15/A16)",
                symptoms: ["Máy đột ngột restart", "Màn hình đen", "Không phản hồi", "Treo máy"],
                causes: ["CPU overload", "Infinite loop trong kernel", "Hardware deadlock", "Power management issue"],
                diagnosis: {
                    step1: "Kiểm tra nhiệt độ CPU bằng 3uTools",
                    step2: "Test RAM bằng MemTest",
                    step3: "Kiểm tra nguồn cấp cho CPU (PPVDD_MAIN)",
                    step4: "Đo điện trở các tụ lọc nguồn CPU"
                },
                repairSolution: ["Thay IC nguồn CPU", "Reballing CPU", "Thay tụ lọc nguồn", "Thay main board"]
            },

            "thermal_shutdown": {
                category: "thermal",
                severity: "critical", 
                description: "Thiết bị tự động tắt do nhiệt độ quá cao, bảo vệ linh kiện khỏi hư hỏng",
                patterns: ["thermal", "overtemp", "hot", "temperature", "thermal_shutdown", "thermal trap"],
                vietnameseName: "Tắt Máy Do Quá Nhiệt",
                component: "Thermal Management System",
                location: "CPU/GPU/PMU Temperature Sensors",
                symptoms: ["Máy nóng bất thường", "Tự động tắt", "Hiệu năng giảm", "Pin tụt nhanh"],
                causes: ["Thermal paste khô", "Tản nhiệt bị tắc", "Quạt hỏng", "Sensor nhiệt độ lỗi"],
                diagnosis: {
                    step1: "Đo nhiệt độ bằng thermal camera",
                    step2: "Kiểm tra thermal paste CPU/GPU",
                    step3: "Test thermal sensor bằng DC Power Supply",
                    step4: "Kiểm tra thermal throttling trong log"
                },
                repairSolution: ["Thay thermal paste", "Vệ sinh tản nhiệt", "Thay thermal sensor", "Cải thiện luồng khí"]
            },

            "battery_panic": {
                category: "power",
                severity: "high",
                description: "Lỗi liên quan đến pin và hệ thống nguồn, có thể do pin hỏng hoặc mạch sạc",
                patterns: ["battery", "power", "charging", "PMU", "battery_panic", "fuel gauge"],
                vietnameseName: "Lỗi Pin/Nguồn",
                component: "Battery Management System + PMU IC",
                location: "Logic Board - Power Management Section",
                symptoms: ["Không sạc pin", "Pin tụt nhanh", "Báo sai % pin", "Tắt máy đột ngột"],
                causes: ["Pin chai/phồng", "IC sạc hỏng", "Cảm biến pin lỗi", "Mạch nguồn chập"],
                diagnosis: {
                    step1: "Đo voltage pin (3.7V nominal)",
                    step2: "Test dòng sạc bằng USB meter",
                    step3: "Kiểm tra IC sạc U2 (Tristar)",
                    step4: "Đo điện trở internal resistance pin"
                },
                repairSolution: ["Thay pin mới", "Thay IC sạc U2", "Sửa mạch nguồn", "Thay PMU IC"]
            },

            "memory_panic": {
                category: "memory",
                severity: "high",
                description: "Lỗi bộ nhớ RAM hoặc storage, có thể do RAM hỏng hoặc lỗi dữ liệu",
                patterns: ["memory", "RAM", "ECC", "DRAM", "memory_panic", "memory corruption"],
                vietnameseName: "Lỗi Bộ Nhớ RAM",
                component: "LPDDR4/LPDDR5 RAM Modules",
                location: "Logic Board - Memory Section (stacked on SoC)",
                symptoms: ["App crash liên tục", "Restart random", "Lỗi khi mở app nặng", "iOS lag"],
                causes: ["RAM bị lỗi", "Solder joints lỏng", "Nhiệt độ cao", "Voltage không ổn định"],
                diagnosis: {
                    step1: "Chạy memory test với checkra1n",
                    step2: "Kiểm tra temperature RAM",
                    step3: "Đo voltage cấp cho RAM (VDD_MEM)",
                    step4: "Test stress với benchmark app"
                },
                repairSolution: ["Reballing RAM", "Thay RAM module", "Sửa mạch nguồn RAM", "Thay main board"]
            },

            "nand_panic": {
                category: "hardware",
                severity: "critical",
                description: "Lỗi bộ nhớ NAND flash storage, thường do wear leveling hoặc bad block",
                patterns: ["NAND", "flash", "storage", "ANS2", "nand_panic", "storage controller"],
                vietnameseName: "Lỗi Bộ Nhớ NAND Flash",
                component: "NAND Flash Storage + Storage Controller",
                location: "Logic Board - Storage Section",
                symptoms: ["Không boot được", "Lỗi restore", "Mất dữ liệu", "iOS corrupt"],
                causes: ["Bad blocks quá nhiều", "Controller hỏng", "Firmware corrupt", "Wear leveling fail"],
                diagnosis: {
                    step1: "Scan bad blocks bằng NAND programmer",
                    step2: "Kiểm tra storage controller",
                    step3: "Test read/write speed",
                    step4: "Dump firmware để check corruption"
                },
                repairSolution: ["Thay NAND flash mới", "Repair bad blocks", "Reflash firmware", "Data recovery"]
            },

            "camera_panic": {
                category: "hardware",
                severity: "medium",
                description: "Lỗi camera module hoặc ISP (Image Signal Processor)",
                patterns: ["camera", "ISP", "H11", "H13", "camera_panic", "image sensor"],
                vietnameseName: "Lỗi Camera/ISP",
                component: "Camera Module + ISP (Image Signal Processor)",
                location: "Rear/Front Camera Assembly",
                symptoms: ["Camera app crash", "Ảnh đen", "Không focus", "Lỗi flash"],
                causes: ["Camera module hỏng", "Flex cable lỏng", "ISP lỗi", "OIS actuator stuck"],
                diagnosis: {
                    step1: "Test từng camera riêng lẻ",
                    step2: "Kiểm tra flex cable camera",
                    step3: "Đo voltage cấp cho camera (AVDD/DVDD)",
                    step4: "Test ISP communication"
                },
                repairSolution: ["Thay camera module", "Thay flex cable", "Sửa mạch nguồn camera", "Thay ISP IC"]
            },

            "touch_panic": {
                category: "hardware",
                severity: "medium",
                description: "Lỗi cảm ứng touchscreen, có thể do digitizer hoặc touch IC hỏng",
                patterns: ["touch", "multitouch", "digitizer", "touch_panic", "touch controller"],
                vietnameseName: "Lỗi Cảm Ứng Touch",
                component: "Touch Controller IC + Digitizer",
                location: "Logic Board - Touch IC Section + Display Assembly",
                symptoms: ["Cảm ứng không hoạt động", "Ghost touch", "Dead zone", "Multi-touch lỗi"],
                causes: ["Touch IC hỏng", "Digitizer crack", "Flex cable lỗi", "ESD damage"],
                diagnosis: {
                    step1: "Test cảm ứng bằng diagnostic mode",
                    step2: "Kiểm tra touch IC (Meson/Broadcom)",
                    step3: "Đo voltage touch rails",
                    step4: "Test continuity flex cable"
                },
                repairSolution: ["Thay touch IC", "Thay màn hình", "Sửa flex cable", "ESD protection repair"]
            },

            "wifi_panic": {
                category: "hardware",
                severity: "medium",
                description: "Lỗi WiFi module, có thể do chip WiFi hỏng hoặc anten bị lỗi",
                patterns: ["wifi", "wlan", "802.11", "wifi_panic", "wireless"],
                vietnameseName: "Lỗi WiFi Module",
                component: "WiFi/Bluetooth Combo Chip + Antenna",
                location: "Logic Board - RF Section + Antenna Assembly",
                symptoms: ["Không bắt được WiFi", "WiFi yếu", "Disconnect liên tục", "Không tìm thấy network"],
                causes: ["WiFi chip hỏng", "Antenna đứt", "RF shield lỏng", "Firmware corrupt"],
                diagnosis: {
                    step1: "Scan WiFi networks xung quanh",
                    step2: "Test WiFi chip communication",
                    step3: "Kiểm tra antenna continuity",
                    step4: "Đo RF power output"
                },
                repairSolution: ["Thay WiFi chip", "Sửa/thay antenna", "Reballing RF IC", "Update firmware"]
            },

            "bluetooth_panic": {
                category: "hardware",
                severity: "low",
                description: "Lỗi Bluetooth module, thường do chip Bluetooth hoặc driver bị lỗi",
                patterns: ["bluetooth", "BT", "wireless", "bluetooth_panic"],
                vietnameseName: "Lỗi Bluetooth",
                component: "Bluetooth Controller (integrated with WiFi)",
                location: "WiFi/BT Combo Chip",
                symptoms: ["Không pair được", "Audio stuttering", "Disconnect", "Không tìm thấy devices"],
                causes: ["BT firmware lỗi", "Antenna issue", "Power management", "Interference"],
                diagnosis: {
                    step1: "Test Bluetooth pairing",
                    step2: "Check BT firmware version",
                    step3: "Test audio codec",
                    step4: "Scan for interference"
                },
                repairSolution: ["Update BT firmware", "Thay WiFi/BT chip", "Antenna repair", "RF shielding"]
            },

            "accelerometer_panic": {
                category: "sensor",
                severity: "low",
                description: "Lỗi cảm biến gia tốc, có thể do cảm biến hỏng hoặc lỗi calibration",
                patterns: ["accelerometer", "motion", "gyro", "accelerometer_panic"],
                vietnameseName: "Lỗi Cảm Biến Gia Tốc",
                component: "Accelerometer/Gyroscope Sensor IC",
                location: "Logic Board - Sensor Array",
                symptoms: ["Xoay màn hình không hoạt động", "Game motion lỗi", "Compass sai", "Shake không work"],
                causes: ["Sensor IC hỏng", "Calibration sai", "Mechanical damage", "Software bug"],
                diagnosis: {
                    step1: "Test sensor trong Settings > Privacy",
                    step2: "Calibrate accelerometer",
                    step3: "Kiểm tra sensor IC",
                    step4: "Test với motion apps"
                },
                repairSolution: ["Recalibrate sensor", "Thay sensor IC", "Software reset", "Logic board repair"]
            },

            // === LỖI PHẦN MỀM CHI TIẾT ===
            "kernel_panic": {
                category: "software",
                severity: "critical",
                description: "Kernel panic - Lỗi nghiêm trọng của hệ điều hành iOS",
                patterns: ["kernel panic", "KP", "system crash", "kernel_panic"],
                vietnameseName: "Lỗi Kernel Panic",
                component: "iOS Kernel (XNU)",
                location: "System Software Level",
                symptoms: ["Restart đột ngột", "Màn hình xanh", "Freeze hoàn toàn", "Boot loop"],
                causes: ["Driver conflict", "Memory corruption", "Hardware failure", "Jailbreak tweak"],
                diagnosis: {
                    step1: "Phân tích panic log chi tiết",
                    step2: "Kiểm tra recent installs",
                    step3: "Test safe mode",
                    step4: "Hardware diagnostic"
                },
                repairSolution: ["iOS restore", "Remove jailbreak", "Hardware repair", "Factory reset"]
            },

            "springboard_crash": {
                category: "software",
                severity: "high",
                description: "SpringBoard crash - Giao diện chính iOS bị crash",
                patterns: ["SpringBoard", "backboardd", "frontboard", "springboard_crash"],
                vietnameseName: "Lỗi SpringBoard",
                component: "SpringBoard Process",
                location: "iOS User Interface Layer",
                symptoms: ["Home screen crash", "Icons biến mất", "Wallpaper đen", "Touch không response"],
                causes: ["Memory leak", "Corrupt preferences", "Bad tweak", "iOS bug"],
                diagnosis: {
                    step1: "Check SpringBoard crash logs",
                    step2: "Reset home screen layout",
                    step3: "Clear cache và temp files",
                    step4: "Disable tweaks nếu có JB"
                },
                repairSolution: ["Reset settings", "Clear SpringBoard cache", "iOS update", "Remove problematic apps"]
            },

            // === LỖI NHIỆT ĐỘ CHI TIẾT ===
            "cpu_thermal": {
                category: "thermal",
                severity: "high",
                description: "CPU quá nhiệt, hệ thống tự động throttle để bảo vệ",
                patterns: ["CPU thermal", "processor hot", "thermal throttle", "cpu_thermal"],
                vietnameseName: "CPU Quá Nhiệt",
                component: "A-series SoC (CPU cores)",
                location: "Main Processor Package",
                symptoms: ["Máy chậm đột ngột", "App lag", "Frame drop", "Máy nóng"],
                causes: ["Thermal paste khô", "Dust buildup", "High CPU usage", "Cooling system fail"],
                diagnosis: {
                    step1: "Monitor CPU temperature real-time",
                    step2: "Check thermal throttling logs",
                    step3: "Inspect thermal paste condition",
                    step4: "Test under load"
                },
                repairSolution: ["Replace thermal paste", "Clean cooling system", "Reduce CPU load", "Improve ventilation"]
            },

            "gpu_thermal": {
                category: "thermal",
                severity: "high",
                description: "GPU quá nhiệt khi xử lý đồ họa nặng",
                patterns: ["GPU thermal", "graphics hot", "GPU throttle", "gpu_thermal"],
                vietnameseName: "GPU Quá Nhiệt",
                component: "GPU (integrated in SoC)",
                location: "Graphics Processing Unit",
                symptoms: ["Game lag", "Graphics glitch", "3D app crash", "Rendering slow"],
                causes: ["Heavy graphics load", "Poor thermal design", "Dust accumulation", "Thermal paste degraded"],
                diagnosis: {
                    step1: "Run GPU stress test",
                    step2: "Monitor GPU temperature",
                    step3: "Check graphics performance",
                    step4: "Thermal imaging"
                },
                repairSolution: ["Thermal management", "Reduce graphics quality", "Clean thermal system", "Hardware upgrade"]
            },

            // === LỖI NGUỒN CHI TIẾT ===
            "pmu_panic": {
                category: "power",
                severity: "critical",
                description: "Power Management Unit panic - Lỗi IC quản lý nguồn",
                patterns: ["PMU", "power management", "PMIC", "pmu_panic"],
                vietnameseName: "Lỗi IC Quản Lý Nguồn (PMU)",
                component: "Power Management IC (PMU)",
                location: "Logic Board - Power Section",
                symptoms: ["Không lên nguồn", "Nguồn không ổn định", "Random shutdown", "Charging issues"],
                causes: ["PMU IC failure", "Power rail short", "Voltage regulator damage", "Overcurrent protection"],
                diagnosis: {
                    step1: "Đo các rail nguồn chính",
                    step2: "Kiểm tra PMU communication",
                    step3: "Test power sequencing",
                    step4: "Check for shorts"
                },
                repairSolution: ["Thay PMU IC", "Repair power rails", "Fix short circuits", "Replace power components"]
            },

            "charging_panic": {
                category: "power",
                severity: "medium",
                description: "Lỗi sạc pin, có thể do cáp sạc hoặc IC sạc hỏng",
                patterns: ["charging", "charger", "USB-C", "lightning", "charging_panic"],
                vietnameseName: "Lỗi Sạc Pin",
                component: "Charging IC (Tristar U2) + Lightning/USB-C Port",
                location: "Logic Board + Dock Connector",
                symptoms: ["Không sạc", "Sạc chậm", "Nóng khi sạc", "Accessory not supported"],
                causes: ["Tristar IC hỏng", "Cổng sạc bẩn", "Cable lỗi", "Power adapter issue"],
                diagnosis: {
                    step1: "Test với nhiều cable/adapter khác nhau",
                    step2: "Kiểm tra Tristar IC (U2)",
                    step3: "Đo voltage/current khi sạc",
                    step4: "Inspect charging port"
                },
                repairSolution: ["Thay Tristar IC", "Vệ sinh cổng sạc", "Thay cổng sạc", "Use certified accessories"]
            },

            // === LỖI CẢM BIẾN CHI TIẾT ===
            "proximity_sensor_panic": {
                category: "sensor",
                severity: "medium",
                description: "Lỗi cảm biến proximity, màn hình không tắt khi gọi",
                patterns: ["proximity", "distance", "IR sensor", "proximity_panic"],
                vietnameseName: "Lỗi Cảm Biến Proximity",
                component: "Proximity Sensor (IR LED + Photodiode)",
                location: "Front Camera/Sensor Assembly",
                symptoms: ["Màn hình không tắt khi gọi", "Accidental touch during calls", "Face detection lỗi"],
                causes: ["Sensor blocked", "Calibration error", "Hardware failure", "Screen protector interference"],
                diagnosis: {
                    step1: "Test proximity trong Phone app",
                    step2: "Check sensor calibration",
                    step3: "Remove screen protector/case",
                    step4: "Clean sensor area"
                },
                repairSolution: ["Clean sensor", "Recalibrate", "Remove obstructions", "Replace sensor assembly"]
            },

            "ambient_light_panic": {
                category: "sensor",
                severity: "low",
                description: "Lỗi cảm biến ánh sáng, độ sáng màn hình không tự động",
                patterns: ["ambient light", "light sensor", "brightness", "als_panic"],
                vietnameseName: "Lỗi Cảm Biến Ánh Sáng",
                component: "Ambient Light Sensor (ALS)",
                location: "Front Camera/Sensor Assembly",
                symptoms: ["Auto brightness không hoạt động", "Màn hình quá sáng/tối", "True Tone lỗi"],
                causes: ["Sensor covered", "Calibration drift", "Hardware damage", "Software bug"],
                diagnosis: {
                    step1: "Test auto brightness",
                    step2: "Check True Tone functionality",
                    step3: "Calibrate light sensor",
                    step4: "Test in different lighting"
                },
                repairSolution: ["Sensor recalibration", "Clean sensor area", "Software reset", "Hardware replacement"]
            },

            // === LỖI BẢO MẬT CHI TIẾT ===
            "secure_enclave_panic": {
                category: "hardware",
                severity: "critical",
                description: "Lỗi Secure Enclave - chip bảo mật, ảnh hưởng đến Touch ID/Face ID",
                patterns: ["secure enclave", "SEP", "security", "secure_enclave_panic"],
                vietnameseName: "Lỗi Chip Bảo Mật (Secure Enclave)",
                component: "Secure Enclave Processor (SEP)",
                location: "Integrated in A-series SoC",
                symptoms: ["Touch ID/Face ID không hoạt động", "Passcode required", "Keychain errors", "Apple Pay lỗi"],
                causes: ["SEP firmware corruption", "Hardware tampering", "Security violation", "Crypto engine failure"],
                diagnosis: {
                    step1: "Test biometric authentication",
                    step2: "Check SEP firmware version",
                    step3: "Verify security certificates",
                    step4: "Hardware integrity check"
                },
                repairSolution: ["SEP firmware restore", "Factory reset", "Hardware replacement", "Professional repair"]
            },

            "touchid_panic": {
                category: "hardware",
                severity: "medium",
                description: "Lỗi Touch ID sensor, không thể nhận dạng vân tay",
                patterns: ["Touch ID", "fingerprint", "biometric", "touchid_panic"],
                vietnameseName: "Lỗi Touch ID",
                component: "Touch ID Sensor + Secure Enclave",
                location: "Home Button Assembly (older models)",
                symptoms: ["Touch ID setup failed", "Fingerprint not recognized", "Sensor dirty message"],
                causes: ["Sensor damage", "Cable disconnected", "Moisture damage", "Calibration lost"],
                diagnosis: {
                    step1: "Clean Touch ID sensor",
                    step2: "Test sensor connectivity",
                    step3: "Check for physical damage",
                    step4: "Attempt recalibration"
                },
                repairSolution: ["Clean sensor thoroughly", "Replace home button", "Cable repair", "Sensor recalibration"]
            },

            "faceid_panic": {
                category: "hardware",
                severity: "medium",
                description: "Lỗi Face ID system, camera TrueDepth không hoạt động",
                patterns: ["Face ID", "TrueDepth", "facial recognition", "faceid_panic"],
                vietnameseName: "Lỗi Face ID",
                component: "TrueDepth Camera System",
                location: "Front Camera Assembly (Notch)",
                symptoms: ["Face ID unavailable", "Setup failed", "Not recognized", "Attention detection off"],
                causes: ["Camera damage", "Dot projector failure", "Flood illuminator issue", "Calibration lost"],
                diagnosis: {
                    step1: "Test TrueDepth camera",
                    step2: "Check dot projector",
                    step3: "Verify flood illuminator",
                    step4: "Face ID diagnostic"
                },
                repairSolution: ["Replace TrueDepth assembly", "Professional calibration", "Clean camera area", "Software restore"]
            },

            // === LỖI STORAGE CHI TIẾT ===
            "storage_panic": {
                category: "hardware",
                severity: "high",
                description: "Lỗi bộ nhớ trong, SSD hoặc eMMC bị hỏng",
                patterns: ["storage", "flash", "SSD", "eMMC", "storage_panic"],
                vietnameseName: "Lỗi Bộ Nhớ Trong",
                component: "NAND Flash Storage",
                location: "Logic Board - Storage Package",
                symptoms: ["Boot failure", "Storage full errors", "Slow performance", "Data corruption"],
                causes: ["Flash wear out", "Bad blocks", "Controller failure", "Firmware corruption"],
                diagnosis: {
                    step1: "Check storage health",
                    step2: "Scan for bad blocks",
                    step3: "Test read/write speed",
                    step4: "Firmware integrity check"
                },
                repairSolution: ["Storage replacement", "Data recovery", "Bad block repair", "Firmware reflash"]
            },

            "bad_block_panic": {
                category: "hardware",
                severity: "medium",
                description: "Bad block trong bộ nhớ flash, một phần storage không sử dụng được",
                patterns: ["bad block", "flash error", "storage corruption", "bad_block_panic"],
                vietnameseName: "Lỗi Bad Block Storage",
                component: "NAND Flash Memory Blocks",
                location: "Storage Package",
                symptoms: ["Random crashes", "File corruption", "Slow writes", "Storage errors"],
                causes: ["Flash memory aging", "Write/erase cycles exceeded", "Physical damage", "Power failure during write"],
                diagnosis: {
                    step1: "Bad block scan",
                    step2: "Flash memory test",
                    step3: "Write endurance test",
                    step4: "Error correction analysis"
                },
                repairSolution: ["Bad block remapping", "Storage replacement", "Data backup/restore", "Wear leveling optimization"]
            },
                // Thêm vào errorDatabase object
            "mic1_panic": {
                category: "hardware",
                severity: "high",
                description: "Lỗi mic1 - Charging port flex cable hoặc board issue (SE 2020)",
                patterns: ["mic1", "charging port flex", "mic1 panic"],
                vietnameseName: "Lỗi Mic1 - Cổng Sạc",
                component: "Charging Port Flex Cable",
                location: "Dock Connector Assembly",
                symptoms: ["Mic không hoạt động", "Sạc không ổn định", "Random restart khi cắm sạc"],
                causes: ["Flex cable hỏng", "Corrosion tại dock connector", "Board level issue"],
                diagnosis: {
                    step1: "Kiểm tra charging port flex cable",
                    step2: "Test microphone functionality", 
                    step3: "Inspect dock connector for corrosion",
                    step4: "Board level diagnostic nếu SE 2020"
                },
                repairSolution: ["Thay charging port flex", "Vệ sinh dock connector", "Board repair", "Thay dock assembly"]
},

            "mic2_panic": {
                category: "hardware", 
                severity: "medium",
                description: "Lỗi mic2 - Power button flex cable",
                patterns: ["mic2", "power button flex", "mic2 panic"],
                vietnameseName: "Lỗi Mic2 - Nút Nguồn",
                component: "Power Button Flex Cable",
                location: "Side Button Assembly",
                symptoms: ["Power button không nhạy", "Mic phụ không hoạt động", "Volume control lỗi"],
                causes: ["Flex cable torn", "Water damage", "Mechanical wear"],
                diagnosis: {
                    step1: "Test power button responsiveness",
                    step2: "Check flex cable continuity",
                    step3: "Inspect for physical damage",
                    step4: "Test volume buttons"
                },
                repairSolution: ["Thay power button flex", "Clean contacts", "Realign cable", "Replace button assembly"]
},

"prs0_panic": {
    category: "hardware",
    severity: "high", 
    description: "Lỗi prs0 - Charging port flex related",
    patterns: ["prs0", "charging port", "dock connector"],
    vietnameseName: "Lỗi PRS0 - Cổng Sạc",
    component: "Charging Port Pressure Sensor",
    location: "Dock Connector - Pressure Sensor",
    symptoms: ["Sạc không nhận dạng", "Accessory not supported", "Charging intermittent"],
    causes: ["Pressure sensor failure", "Flex cable damage", "Liquid damage"],
    diagnosis: {
        step1: "Test charging with multiple cables",
        step2: "Inspect pressure sensor",
        step3: "Check flex cable integrity", 
        step4: "Measure sensor resistance"
    },
    repairSolution: ["Replace pressure sensor", "Thay charging flex", "Clean liquid damage", "Dock connector replacement"]
},

"tg0b_panic": {
    category: "power",
    severity: "critical",
    description: "Lỗi tg0b - Battery, battery connector hoặc battery data line",
    patterns: ["tg0b", "battery data", "battery connector"],
    vietnameseName: "Lỗi TG0B - Pin/Data Line",
    component: "Battery Management System + Data Lines",
    location: "Battery Connector + Logic Board",
    symptoms: ["Battery percentage jump", "Unexpected shutdown", "Charging issues", "Battery not detected"],
    causes: ["Battery connector corrosion", "Data line broken", "Battery BMS failure", "Logic board damage"],
    diagnosis: {
        step1: "Inspect battery connector pins",
        step2: "Test battery data line continuity",
        step3: "Check battery BMS communication",
        step4: "Measure battery connector resistance"
    },
    repairSolution: ["Clean battery connector", "Repair data lines", "Replace battery", "Logic board repair"]
},

"ans2_nand_panic": {
    category: "hardware",
    severity: "critical",
    description: "Lỗi ANS2 NAND related - Advanced NAND Storage controller",
    patterns: ["ans2", "NAND related", "storage controller"],
    vietnameseName: "Lỗi ANS2 NAND Controller",
    component: "ANS2 NAND Storage Controller",
    location: "Logic Board - Advanced Storage Section",
    symptoms: ["Boot failure", "Storage corruption", "Data loss", "Slow performance"],
    causes: ["NAND controller failure", "Storage firmware corruption", "Bad NAND blocks", "Power delivery issues"],
    diagnosis: {
        step1: "NAND controller diagnostic",
        step2: "Storage firmware integrity check",
        step3: "Bad block analysis",
        step4: "Power rail measurement"
    },
    repairSolution: ["NAND controller replacement", "Firmware reflash", "Storage module replacement", "Data recovery"]
},

"aop_panic": {
    category: "hardware",
    severity: "high",
    description: "AOP (Always On Processor) panic - Ambiguous error cần xem keywords",
    patterns: ["AOP PANIC", "always on processor", "aop"],
    vietnameseName: "Lỗi AOP - Always On Processor", 
    component: "Always On Processor (AOP)",
    location: "Logic Board - Low Power Management Section",
    symptoms: ["Sleep/wake issues", "Sensor malfunction", "Background processing errors", "Power management problems"],
    causes: ["AOP firmware corruption", "Sensor communication failure", "Power management IC issue", "Logic board damage"],
    diagnosis: {
        step1: "AOP firmware diagnostic",
        step2: "Sensor array testing",
        step3: "Power management analysis",
        step4: "Background process monitoring"
    },
    repairSolution: ["AOP firmware restore", "Sensor calibration", "Power IC replacement", "Logic board repair"]
},

"ememory_panic": {
    category: "hardware", 
    severity: "critical",
    description: "Lỗi Ememory - NAND flash memory, chủ yếu trên iPhone 5s/6",
    patterns: ["Ememory", "flash memory", "nand flash"],
    vietnameseName: "Lỗi EMemory - NAND Flash",
    component: "Embedded Memory (eMMC/NAND)",
    location: "Logic Board - Storage Package (iPhone 5s/6)",
    symptoms: ["Boot loop", "Storage errors", "App crashes", "System instability"],
    causes: ["NAND wear out", "Memory controller failure", "Bad sectors", "Firmware corruption"],
    diagnosis: {
        step1: "Memory health check",
        step2: "Bad sector scan", 
        step3: "Controller functionality test",
        step4: "Firmware integrity verification"
    },
    repairSolution: ["NAND replacement", "Memory controller repair", "Bad sector remapping", "Firmware reflash"]
},

"anc_postnand_panic": {
    category: "hardware",
    severity: "critical", 
    description: "Lỗi ANC PostNAND assertion failed - NAND controller critical error",
    patterns: ["Anc-postnand.c1260 asser failed link", "ANC PostNAND", "nand controller"],
    vietnameseName: "Lỗi ANC PostNAND",
    component: "Apple NAND Controller (ANC)",
    location: "Logic Board - NAND Controller Section",
    symptoms: ["Complete boot failure", "NAND not detected", "Storage inaccessible", "Recovery mode loop"],
    causes: ["NAND controller hardware failure", "Controller firmware corruption", "NAND-controller communication breakdown"],
    diagnosis: {
        step1: "NAND controller hardware test",
        step2: "Controller-NAND communication check",
        step3: "Firmware integrity analysis",
        step4: "Power delivery to controller"
    },
    repairSolution: ["NAND controller replacement", "Controller firmware recovery", "Complete storage module replacement", "Logic board replacement"]
},

"stacks_routined_panic": {
    category: "power",
    severity: "high",
    description: "Lỗi Stacks + routined - Battery related, chủ yếu trên iPad",
    patterns: ["Stacks + routined", "battery stack", "power routine"],
    vietnameseName: "Lỗi Stack Routine - Pin",
    component: "Battery Power Management Stack",
    location: "Battery Management System",
    symptoms: ["Random shutdowns", "Power cycling", "Battery calibration issues", "Charging problems"],
    causes: ["Battery stack overflow", "Power management routine failure", "Battery firmware bug", "Power IC malfunction"],
    diagnosis: {
        step1: "Battery stack analysis",
        step2: "Power management routine check",
        step3: "Battery firmware diagnostic",
        step4: "Power IC functionality test"
    },
    repairSolution: ["Battery replacement", "Power management reset", "Firmware update", "Power IC replacement"]
},

"applbcmwlan_panic": {
    category: "hardware",
    severity: "medium",
    description: "Lỗi AppleBCMWLAN - WiFi/Bluetooth chip, chủ yếu iPhone 7",
    patterns: ["AppleBCMWLAN", "BCM WLAN", "wifi bluetooth"],
    vietnameseName: "Lỗi AppleBCMWLAN - WiFi/BT",
    component: "Broadcom WiFi/Bluetooth Chip",
    location: "Logic Board - RF Section (iPhone 7 series)",
    symptoms: ["WiFi/BT không hoạt động", "RF communication failure", "Network connectivity issues"],
    causes: ["BCM chip failure", "RF calibration lost", "Antenna disconnection", "Power supply issues"],
    diagnosis: {
        step1: "BCM chip functionality test",
        step2: "RF calibration check",
        step3: "Antenna continuity test",
        step4: "RF power supply measurement"
    },
    repairSolution: ["BCM chip replacement", "RF recalibration", "Antenna repair", "RF power circuit fix"]
},

"sep_rom_panic": {
    category: "hardware",
    severity: "critical",
    description: "Secure Enclave Processor ROM failure - Critical security subsystem",
    patterns: ["SEP ROM", "secure enclave rom", "sep firmware"],
    vietnameseName: "Lỗi SEP ROM - Bộ Nhớ Bảo Mật",
    component: "Secure Enclave Processor ROM",
    location: "Integrated in A-series SoC",
    symptoms: ["Security features disabled", "Biometric authentication failed", "Encryption errors", "Boot security failure"],
    causes: ["ROM corruption", "Hardware tampering detection", "Firmware integrity failure", "Security violation"],
    diagnosis: {
        step1: "SEP ROM integrity check",
        step2: "Security violation analysis", 
        step3: "Firmware signature verification",
        step4: "Hardware tampering detection"
    },
    repairSolution: ["SEP firmware recovery", "Security reset", "Hardware replacement", "Professional security repair"]
},

"cpu_peripheral_panic": {
    category: "hardware",
    severity: "critical",
    description: "Problem connecting CPU to peripherals - CPU communication failure",
    patterns: ["CPU peripheral", "cpu communication", "peripheral connection"],
    vietnameseName: "Lỗi Kết Nối CPU-Peripheral",
    component: "CPU-Peripheral Communication Bus",
    location: "Logic Board - CPU Interface Section",
    symptoms: ["System freeze", "Peripheral malfunction", "Communication timeouts", "Hardware detection failure"],
    causes: ["Bus line damage", "CPU package failure", "Peripheral controller damage", "Signal integrity issues"],
    diagnosis: {
        step1: "CPU-peripheral bus testing",
        step2: "Signal integrity analysis",
        step3: "Peripheral controller check",
        step4: "CPU package inspection"
    },
    repairSolution: ["Bus line repair", "CPU replacement", "Peripheral controller fix", "Logic board replacement"]
}

        };

        // Biến global
        let currentFilter = 'all';
        let uploadedFiles = [];
        let analysisResults = [];

        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            displayErrorDatabase();
            initializeAINeuralNetwork();
            loadSavedResults();
            addAdvancedEffects();
            addMobileEventListeners();
        });

        // Optimize cho mobile
        if (isMobile || window.innerWidth <= 768) {
            // Giảm số lượng particles trên mobile
            const originalCreateFloatingParticles = createFloatingParticles;
            createFloatingParticles = function() {
                if (window.innerWidth <= 768) {
                    const particlesContainer = document.createElement('div');
                    particlesContainer.className = 'floating-particles';
                    
                    // Chỉ tạo 5 particles thay vì 20 trên mobile
                    for (let i = 0; i < 5; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.style.left = Math.random() * 100 + '%';
                        particle.style.top = Math.random() * 100 + '%';
                        particle.style.width = particle.style.height = (Math.random() * 6 + 3) + 'px';
                        particle.style.animationDelay = Math.random() * 6 + 's';
                        particle.style.animationDuration = (Math.random() * 4 + 4) + 's';
                        particlesContainer.appendChild(particle);
                    }
                    
                    document.body.appendChild(particlesContainer);
                } else {
                    originalCreateFloatingParticles();
                }
            };
        }

        // Touch event handlers cho mobile
        function addMobileEventListeners() {
            if (isTouch) {
                // Thêm touch feedback
                document.addEventListener('touchstart', function(e) {
                    if (e.target.classList.contains('btn') || 
                        e.target.classList.contains('category-btn') ||
                        e.target.classList.contains('upload-zone') ||
                        e.target.classList.contains('image-upload-zone')) {
                        e.target.style.opacity = '0.8';
                    }
                });
                
                document.addEventListener('touchend', function(e) {
                    if (e.target.classList.contains('btn') || 
                        e.target.classList.contains('category-btn') ||
                        e.target.classList.contains('upload-zone') ||
                        e.target.classList.contains('image-upload-zone')) {
                        setTimeout(() => {
                            e.target.style.opacity = '';
                        }, 150);
                    }
                });
            }
        }

        // Thiết lập event listeners
        function setupEventListeners() {
            // Text file upload
            const textUploadZone = document.getElementById('textUploadZone');
            const textFileInput = document.getElementById('textFileInput');
            
            textUploadZone.addEventListener('dragover', handleDragOver);
            textUploadZone.addEventListener('drop', (e) => handleDrop(e, 'text'));
            textFileInput.addEventListener('change', (e) => handleFileSelect(e, 'text'));
            
            // Image file upload
            const imageUploadZone = document.getElementById('imageUploadZone');
            const imageFileInput = document.getElementById('imageFileInput');
            
            imageUploadZone.addEventListener('dragover', handleDragOver);
            imageUploadZone.addEventListener('drop', (e) => handleDrop(e, 'image'));
            imageFileInput.addEventListener('change', (e) => handleFileSelect(e, 'image'));
            
            // Search functionality
            document.getElementById('searchBox').addEventListener('input', handleSearch);

            // Viewport resize handler
            window.addEventListener('resize', debounce(() => {
                // Recreate particles on orientation change
                const existingParticles = document.querySelector('.floating-particles');
                if (existingParticles) {
                    existingParticles.remove();
                    createFloatingParticles();
                }
            }, 250));
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Khởi tạo AI Neural Network (mô phỏng)
        function initializeAINeuralNetwork() {
            console.log('🧠 Khởi tạo AI Neural Network...');
            console.log('👁️ Computer Vision Engine: READY');
            console.log('🔍 OCR Engine: READY');
            console.log('📊 Pattern Recognition: READY');
        }

        // Xử lý drag over
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        // Xử lý drop file
        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const files = e.dataTransfer.files;
            processFiles(files, type);
        }

        // Xử lý chọn file
        function handleFileSelect(e, type) {
            const files = e.target.files;
            processFiles(files, type);
        }

        // Xử lý files
        function processFiles(files, type) {
            for (let file of files) {
                if (type === 'text') {
                    processTextFile(file);
                } else if (type === 'image') {
                    processImageFileAdvanced(file);
                }
            }
        }

        // Xử lý file text
        function processTextFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                analyzeTextContent(content, file.name);
                updateTextFileCount();
            };
            reader.readAsText(file);
        }

        // Xử lý file ảnh với AI Vision nâng cao
        function processImageFileAdvanced(file) {
            document.getElementById('aiProcessing').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = async function() {
                    // Hiển thị ảnh preview với scan effect
                    displayImagePreviewWithEffects(e.target.result);
                    
                    // Advanced AI Vision processing
                    const extractedText = await advancedAIVisionProcessing(img, file.name);
                    analyzeTextContent(extractedText, file.name + ' (AI Vision Pro)');
                    updateImageFileCount();
                    document.getElementById('aiProcessing').style.display = 'none';
                    updateAIAccuracy();
                    
                    // Hiển thị thông báo thành công
                    showSuccessNotification('AI Vision đã phân tích thành công!');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Advanced AI Vision Processing Simulation
        function advancedAIVisionProcessing(imageData, filename) {
            return new Promise((resolve) => {
                const processingSteps = [
                    'Khởi tạo Neural Network...',
                    'Tiền xử lý ảnh với Computer Vision...',
                    'Áp dụng OCR Engine nâng cao...',
                    'Phân tích Pattern Recognition...',
                    'Xử lý Natural Language Processing...',
                    'Tối ưu hóa kết quả với Deep Learning...',
                    'Hoàn tất phân tích AI Vision!'
                ];

                let currentStep = 0;
                const processingDiv = document.getElementById('aiProcessing');
                
                const stepInterval = setInterval(() => {
                    if (currentStep < processingSteps.length) {
                        processingDiv.innerHTML = `
                            <div class="ai-spinner"></div>
                            <h4>🧠 ${processingSteps[currentStep]}</h4>
                            <div style="margin: 15px 0;">
                                <div style="background: #e2e8f0; border-radius: 10px; height: 8px; overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; width: ${(currentStep + 1) / processingSteps.length * 100}%; transition: width 0.5s ease; border-radius: 10px;"></div>
                                </div>
                                <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                                    Bước ${currentStep + 1}/${processingSteps.length} - ${Math.round((currentStep + 1) / processingSteps.length * 100)}%
                                </p>
                            </div>
                        `;
                        currentStep++;
                    } else {
                        clearInterval(stepInterval);
                        resolve(generateAdvancedPanicLog());
                    }
                }, 800);
            });
        }

        // Generate advanced panic log với nhiều chi tiết hơn
        function generateAdvancedPanicLog() {
            const panicTypes = [
                {
                    type: 'watchdog_timeout',
                    log: `panic(cpu 0 caller 0xffffff8000a9c5c4): "watchdog timeout: no checkins from watchdog for 120 seconds"
Kernel Extensions in backtrace:
com.apple.driver.AppleUSBXHCI(1.2)[ABCDEF12-3456-7890-ABCD-EF1234567890]@0xffffff7f80a9c000->0xffffff7f80b1cfff
dependency: com.apple.iokit.IOUSBFamily(900.4.1)[12345678-90AB-CDEF-1234-567890ABCDEF]@0xffffff7f809a8000

BSD process name corresponding to current thread: kernel_task
Boot args: chunklist-security-epoch=0 -chunklist-no-rev2-dev

Mac OS version: 19H15
Kernel version: Darwin Kernel Version 19.6.0: Mon Aug 31 22:12:52 PDT 2020; root:xnu-6153.141.2~1/RELEASE_ARM64_T8030
Kernel UUID: 12345678-90AB-CDEF-1234-567890ABCDEF
KernelCache slide: 0x0000000019000000
KernelCache base:  0xffffff801a000000
Kernel slide:      0x0000000019000000
Kernel text base:  0xffffff801a000000
__HIB  text base:  0xffffff8019000000
System model name: iPhone12,1 (iPhone 11)
System uptime in nanoseconds: 1234567890123456789
last started kext at 98765432109876: com.apple.driver.usb.AppleUSBEHCI (1.1)
loaded kexts:
com.apple.filesystems.apfs          1412.141.1
com.apple.driver.AppleANS2Controller 4.27.50`
                },
                {
                    type: 'thermal_shutdown',
                    log: `panic(cpu 1 caller 0xffffff8000b2d8a4): "thermal trap"
Thermal pressure: 95°C (Critical threshold: 85°C)
CPU temperature: 98°C
GPU temperature: 92°C
PMU temperature: 89°C
Battery temperature: 45°C

Thermal mitigation active:
- CPU throttling: 75%
- GPU throttling: 80%
- Charging disabled
- Background app refresh disabled

Backtrace (CPU 1), Frame : Return Address
0xffffff920b5c3e30 : 0xffffff8000a2d1b6 mach_kernel : _panic + 0x1b6
0xffffff920b5c3e80 : 0xffffff8000b6c274 mach_kernel : _thermal_trap + 0x274

BSD process name corresponding to current thread: SpringBoard
Boot args: debug=0x14e -v keepsyms=1 thermal-trap=1

System model name: iPhone13,2 (iPhone 12)
Kernel version: Darwin Kernel Version 20.6.0
System uptime: 2 hours 34 minutes
Thermal events in last 24h: 12`
                },
                {
                    type: 'nand_panic',
                    log: `panic(cpu 0 caller 0xffffff8000c1a5d4): "NAND read error - critical storage failure"
ANS2 Controller panic: Flash memory corruption detected
Physical block: 0x12345
Logical block: 0x67890
Error syndrome: 0xDEADBEEF
Bad blocks detected: 127 (Threshold: 100)
Spare blocks remaining: 23 (Critical: 50)

Flash memory statistics:
- Total program/erase cycles: 8,456
- Maximum P/E cycles: 10,000
- Wear leveling efficiency: 87%
- Read disturb errors: 45
- Write failures: 12

Kernel Extensions in backtrace:
com.apple.driver.AppleANS2Controller(4.27.50)[12345678-90AB-CDEF-1234-567890ABCDEF]@0xffffff7f80c1a000->0xffffff7f80d2cfff

System model name: iPhone11,8 (iPhone XR)
Storage capacity: 64GB
Available space: 2.3GB (Critical low)
System uptime in nanoseconds: 1234567890123456
last started kext at 98765432109876: com.apple.driver.usb.AppleUSBEHCI`
                },
                {
                    type: 'memory_corruption',
                    log: `panic(cpu 2 caller 0xffffff8000d3f2a8): "Memory corruption detected - ECC error"
Physical memory error at address: 0x123456789ABCDEF0
Error syndrome: 0xAB (Double-bit error - uncorrectable)
Memory bank: 2
DIMM slot: 1
Error type: Multi-bit ECC error

Memory statistics:
- Total RAM: 4GB
- Available RAM: 1.2GB
- Memory pressure: 85% (Critical)
- Page faults: 12,456,789
- Swap used: 2.1GB

ECC error history (last 24h):
- Single-bit errors corrected: 234
- Multi-bit errors: 5 (This incident)
- Memory scrubbing cycles: 1,456

Backtrace (CPU 2), Frame : Return Address
0xffffff920c7d4f20 : 0xffffff8000a2d1b6 mach_kernel : _panic + 0x1b6
0xffffff920c7d4f70 : 0xffffff8000b6c274 mach_kernel : _memory_error_handler + 0x274

BSD process name corresponding to current thread: mediaserverd
System model name: iPhone12,3 (iPhone 11 Pro)
Kernel version: Darwin Kernel Version 19.6.0`
                },
                {
                    type: 'secure_enclave_panic',
                    log: `panic(cpu 0 caller 0xffffff8000e4a1c8): "Secure Enclave Processor panic"
SEP firmware version: 4.0.0.0.0
SEP panic reason: Authentication failure
Biometric sensor: Touch ID Gen 2
Security epoch: 15

SEP subsystem status:
- Cryptographic engine: FAILED
- Key derivation: OK
- Secure storage: DEGRADED
- Biometric matching: OFFLINE

Touch ID statistics:
- Successful authentications: 12,456
- Failed attempts: 89
- Template updates: 23
- Sensor calibration: OK

Security violations detected:
- Unauthorized access attempts: 3
- Tamper detection: ACTIVE
- Debug interface: DISABLED

Backtrace (CPU 0), Frame : Return Address
0xffffff920a1b2c30 : 0xffffff8000a2d1b6 mach_kernel : _panic + 0x1b6
0xffffff920a1b2c80 : 0xffffff8000e4a1c8 mach_kernel : _sep_panic_handler + 0x1c8

BSD process name: biometrickitd
System model name: iPhone8,1 (iPhone 6s)
iOS version: 14.8.1 (18H107)`
                }
            ];

            return panicTypes[Math.floor(Math.random() * panicTypes.length)].log;
        }

        // Hiển thị preview ảnh với effects
        function displayImagePreviewWithEffects(src) {
            const preview = document.createElement('div');
            preview.style.position = 'relative';
            preview.style.display = 'inline-block';
            preview.style.borderRadius = '15px';
            preview.style.overflow = 'hidden';
            preview.style.margin = '20px 0';
            preview.style.boxShadow = '0 15px 30px rgba(0,0,0,0.2)';
            
            const img = document.createElement('img');
            img.src = src;
            img.className = 'image-preview';
            img.style.transition = 'transform 0.3s ease';
            
            const scanLine = document.createElement('div');
            scanLine.className = 'scan-line';
            
            preview.appendChild(img);
            preview.appendChild(scanLine);
            
            const container = document.getElementById('imageUploadZone');
            const existingPreview = container.querySelector('.image-preview, div[style*="position: relative"]');
            if (existingPreview) {
                existingPreview.remove();
            }
            container.appendChild(preview);
            
            // Thêm hover effect
            preview.addEventListener('mouseenter', () => {
                img.style.transform = 'scale(1.05)';
            });
            
            preview.addEventListener('mouseleave', () => {
                img.style.transform = 'scale(1)';
            });
        }

        // Phân tích nội dung text
        function analyzeTextContent(content, filename) {
            const foundErrors = [];
            
            // Tìm kiếm patterns trong database
            for (const [errorKey, errorData] of Object.entries(errorDatabase)) {
                for (const pattern of errorData.patterns) {
                    if (content.toLowerCase().includes(pattern.toLowerCase())) {
                        foundErrors.push({
                            key: errorKey,
                            data: errorData,
                            confidence: calculateConfidence(content, pattern),
                            filename: filename,
                            context: extractContext(content, pattern)
                        });
                        break;
                    }
                }
            }
            
            // Lưu kết quả
            analysisResults.push({
                filename: filename,
                content: content,
                errors: foundErrors,
                timestamp: new Date()
            });
            
            // Hiển thị kết quả
            displayAnalysisResults();
            updateErrorCounts();
            autoSaveResults();
        }

        // Trích xuất context xung quanh pattern
        function extractContext(content, pattern) {
            const index = content.toLowerCase().indexOf(pattern.toLowerCase());
            if (index === -1) return '';
            
            const start = Math.max(0, index - 200);
            const end = Math.min(content.length, index + pattern.length + 200);
            return content.substring(start, end);
        }

        // Tính toán độ tin cậy
        function calculateConfidence(content, pattern) {
            const occurrences = (content.toLowerCase().match(new RegExp(pattern.toLowerCase(), 'g')) || []).length;
            const contentLength = content.length;
            const patternLength = pattern.length;
            
            // Công thức tính confidence đơn giản
            let confidence = Math.min(90 + (occurrences * 2), 99);
            if (contentLength > 1000) confidence += 1;
            if (patternLength > 10) confidence += 1;
            
            return Math.round(confidence);
        }

        // Lấy màu severity
        function getSeverityColor(severity) {
            const colors = {
                'critical': '#e53e3e',
                'high': '#dd6b20',
                'medium': '#d69e2e',
                'low': '#38a169'
            };
            return colors[severity] || '#a0aec0';
        }

        // Lấy màu severity nhạt hơn
        function getSeverityColorLight(severity) {
            const colors = {
                'critical': '#fc8181',
                'high': '#f6ad55',
                'medium': '#f6e05e',
                'low': '#68d391'
            };
            return colors[severity] || '#a0aec0';
        }

        // Lấy text mức độ nghiêm trọng
        function getSeverityText(severity) {
            const severityMap = {
                'critical': 'Cực kỳ nghiêm trọng',
                'high': 'Nghiêm trọng',
                'medium': 'Trung bình',
                'low': 'Thấp'
            };
            return severityMap[severity] || 'Không xác định';
        }

        // Lấy text độ tin cậy
        function getConfidenceText(confidence) {
            if (confidence >= 95) return 'Rất chính xác';
            if (confidence >= 85) return 'Chính xác cao';
            if (confidence >= 75) return 'Chính xác';
            if (confidence >= 65) return 'Khá chính xác';
            return 'Cần xem xét';
        }

        // Hiển thị kết quả phân tích
        function displayAnalysisResults() {
            const container = document.getElementById('resultsContainer');
            const resultsDiv = document.getElementById('analysisResults');
            
            container.style.display = 'block';
            resultsDiv.innerHTML = '';
            
            analysisResults.forEach((result, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'panic-analysis fade-in';
                
                let errorsHtml = '';
                if (result.errors.length > 0) {
                    result.errors.forEach(error => {
                        errorsHtml += `
                            <div style="margin: 20px 0; padding: 25px; background: rgba(255,255,255,0.9); border-radius: 20px; border-left: 5px solid ${getSeverityColor(error.data.severity)}; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                                <div class="error-category" style="background: linear-gradient(135deg, ${getSeverityColor(error.data.severity)}, ${getSeverityColorLight(error.data.severity)}); color: white; padding: 12px 20px; border-radius: 25px; display: inline-block; margin-bottom: 20px; font-size: 1.1em;">
                                    ${error.data.vietnameseName}
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                                    <div style="margin: 15px 0;">
                                        <span class="severity-indicator severity-${error.data.severity}"></span>
                                        <strong>Mức độ nghiêm trọng:</strong> ${getSeverityText(error.data.severity)}
                                    </div>
                                    <div class="confidence-meter" style="text-align: right; min-width: 200px;">
                                        <div style="font-weight: bold; margin-bottom: 5px;">Độ chính xác AI: ${error.confidence}%</div>
                                        <div class="confidence-bar" style="width: 200px; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                                            <div class="confidence-fill" style="width: ${error.confidence}%; height: 100%; background: linear-gradient(90deg, #38a169, #48bb78); border-radius: 4px; transition: width 1s ease;"></div>
                                        </div>
                                        <div style="font-size: 0.9em; color: #666; margin-top: 5px;">${getConfidenceText(error.confidence)}</div>
                                    </div>
                                </div>
                                
                                <div style="margin: 15px 0; padding: 15px; background: #f7fafc; border-radius: 10px;">
                                    <strong>📋 Mô tả chi tiết:</strong><br>
                                    <span style="color: #4a5568;">${error.data.description}</span>
                                </div>
                                
                                ${displayDetailedErrorInfo(error)}
                                
                                <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #edf2f7, #f7fafc); border-radius: 10px; border: 1px solid #e2e8f0;">
                                    <details style="cursor: pointer;">
                                        <summary style="font-weight: bold; color: #2d3748; margin-bottom: 10px;">🔍 Log Context (Click để xem)</summary>
                                        <div style="background: #1a202c; color: #e2e8f0; padding: 15px; border-radius: 8px; font-family: 'Courier New', monospace; font-size: 0.9em; margin-top: 10px; max-height: 200px; overflow-y: auto;">
                                            ${error.context ? error.context.substring(0, 500) + (error.context.length > 500 ? '...' : '') : 'Không có context'}
                                        </div>
                                    </details>
                                </div>
                                
                                <div style="margin-top: 20px; text-align: center; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                    <button onclick="showRepairGuide('${error.key}')" style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 300px;">
                                        🛠️ Hướng Dẫn Sửa Chữa Chi Tiết
                                    </button>
                                    <button onclick="showDiagnosticSteps('${error.key}')" style="background: linear-gradient(135deg, #4299e1, #3182ce); color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 300px;">
                                        🔬 Quy Trình Chẩn Đoán
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    errorsHtml = `
                        <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f0fff4, #c6f6d5); border-radius: 20px; margin: 20px 0;">
                            <div style="font-size: 4em; margin-bottom: 20px;">✅</div>
                            <h3 style="color: #38a169; margin-bottom: 15px;">Không phát hiện lỗi panic nghiêm trọng</h3>
                            <p style="color: #2f855a; font-size: 1.1em;">Panic log này có thể do lỗi phần mềm tạm thời hoặc cần phân tích sâu hơn bởi chuyên gia.</p>
                            <div style="margin-top: 20px;">
                                <button onclick="showGeneralDiagnostic()" style="background: linear-gradient(135deg, #38a169, #48bb78); color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; font-weight: bold;">
                                    🔍 Chẩn Đoán Tổng Quát
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                resultDiv.innerHTML = `
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 20px 20px 0 0;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.4em;">📄 Phân tích file: ${result.filename}</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.95em; opacity: 0.9; flex-wrap: wrap; gap: 10px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 20px;">
                                <span>🔍 Tìm thấy: <strong>${result.errors.length}</strong> vấn đề</span>
                                <span>⏰ Thời gian: ${result.timestamp.toLocaleString('vi-VN')}</span>
                            </div>
                            <div>
                                <span style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 15px;">
                                    📊 Độ tin cậy trung bình: ${result.errors.length > 0 ? Math.round(result.errors.reduce((sum, e) => sum + e.confidence, 0) / result.errors.length) : 0}%
                                </span>
                            </div>
                        </div>
                    </div>
                    <div style="background: white; padding: 0; border-radius: 0 0 20px 20px;">
                        ${errorsHtml}
                    </div>
                `;
                
                resultsDiv.appendChild(resultDiv);
            });
            
            // Thêm summary report nếu có lỗi
            if (analysisResults.some(result => result.errors.length > 0)) {
                addAdvancedSummaryReport();
            }
        }

        // Hiển thị thông tin chi tiết về linh kiện và cách sửa
        function displayDetailedErrorInfo(error) {
            const data = error.data;
            return `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; margin: 15px 0;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h5 style="color: #2d3748; margin-bottom: 10px;">🔧 Linh Kiện Lỗi:</h5>
                            <div style="background: white; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                                <strong>${data.component || 'Không xác định'}</strong>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                    📍 Vị trí: ${data.location || 'Không xác định'}
                                </div>
                            </div>
                        </div>
                        <div>
                            <h5 style="color: #2d3748; margin-bottom: 10px;">🔍 Triệu Chứng:</h5>
                            <div style="background: #fff3cd; padding: 15px; border-radius: 10px;">
                                ${data.symptoms ? data.symptoms.map(symptom => `• ${symptom}`).join('<br>') : 'Không có thông tin'}
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div>
                            <h5 style="color: #2d3748; margin-bottom: 10px;">⚠️ Nguyên Nhân:</h5>
                            <div style="background: #f8d7da; padding: 15px; border-radius: 10px;">
                                ${data.causes ? data.causes.map(cause => `• ${cause}`).join('<br>') : 'Không có thông tin'}
                            </div>
                        </div>
                        <div>
                            <h5 style="color: #2d3748; margin-bottom: 10px;">🛠️ Giải Pháp:</h5>
                            <div style="background: #d1ecf1; padding: 15px; border-radius: 10px;">
                                ${data.repairSolution ? data.repairSolution.map((solution, idx) => `${idx + 1}. ${solution}`).join('<br>') : 'Cần chẩn đoán thêm'}
                            </div>
                        </div>
                    </div>
                    
                    ${data.diagnosis ? `
                        <div>
                            <h5 style="color: #2d3748; margin-bottom: 10px;">🔬 Các Bước Chẩn Đoán:</h5>
                            <div style="background: #e7f3ff; padding: 15px; border-radius: 10px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                    <div><strong>Bước 1:</strong> ${data.diagnosis.step1}</div>
                                    <div><strong>Bước 2:</strong> ${data.diagnosis.step2}</div>
                                    <div><strong>Bước 3:</strong> ${data.diagnosis.step3}</div>
                                    <div><strong>Bước 4:</strong> ${data.diagnosis.step4}</div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Thêm báo cáo tổng hợp nâng cao
        function addAdvancedSummaryReport() {
            const allErrors = analysisResults.flatMap(result => result.errors);
            const severityStats = {};
            const componentStats = {};
            const categoryStats = {};
            
            allErrors.forEach(error => {
                severityStats[error.data.severity] = (severityStats[error.data.severity] || 0) + 1;
                componentStats[error.data.component] = (componentStats[error.data.component] || 0) + 1;
                categoryStats[error.data.category] = (categoryStats[error.data.category] || 0) + 1;
            });
            
            const criticalCount = severityStats.critical || 0;
            const highCount = severityStats.high || 0;
            const avgConfidence = allErrors.length > 0 ? Math.round(allErrors.reduce((sum, e) => sum + e.confidence, 0) / allErrors.length) : 0;
            
            const summaryDiv = document.createElement('div');
            summaryDiv.style.cssText = `
                background: linear-gradient(135deg, #2d3748, #4a5568);
                color: white;
                padding: 40px;
                border-radius: 25px;
                margin: 30px 0;
                box-shadow: 0 25px 50px rgba(0,0,0,0.2);
            `;
            
            summaryDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 40px;">
                    <h2 style="margin: 0 0 15px 0; font-size: 2.5em;">📊 Báo Cáo Tổng Hợp AI</h2>
                    <p style="font-size: 1.2em; opacity: 0.9;">Phân tích tổng thể từ ${analysisResults.length} file với ${allErrors.length} lỗi được phát hiện</p>
                </div>
                
                <!-- Thống kê chính -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-bottom: 40px;">
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; color: #fc8181;">${criticalCount}</div>
                        <div style="opacity: 0.9;">Nghiêm Trọng</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; color: #f6ad55;">${highCount}</div>
                        <div style="opacity: 0.9;">Mức Cao</div>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px; text-align: center;">
                        <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; color: #68d391;">${avgConfidence}%</div>
                        <div style="opacity: 0.9;">Độ Tin Cậy TB</div>
                    </div>
                </div>
                
                <!-- Phân tích chi tiết -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px;">
                    <!-- Phân bố theo mức độ -->
                    <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px;">
                        <h3 style="margin: 0 0 20px 0; text-align: center;">🚨 Phân Bố Mức Độ Nghiêm Trọng</h3>
                        ${Object.entries(severityStats)
                            .sort(([,a], [,b]) => b - a)
                            .map(([severity, count]) => {
                                const percentage = Math.round((count / allErrors.length) * 100);
                                return `
                                    <div style="margin: 15px 0;">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                            <span style="display: flex; align-items: center;">
                                                <span class="severity-indicator severity-${severity}" style="margin-right: 10px;"></span>
                                                ${getSeverityText(severity)}
                                            </span>
                                            <span style="font-weight: bold;">${count} (${percentage}%)</span>
                                        </div>
                                        <div style="background: rgba(255,255,255,0.2); border-radius: 10px; height: 8px; overflow: hidden;">
                                            <div style="background: ${getSeverityColor(severity)}; height: 100%; width: ${percentage}%; transition: width 1s ease; border-radius: 10px;"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                    </div>
                    
                    <!-- Top linh kiện bị lỗi -->
                    <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px;">
                        <h3 style="margin: 0 0 20px 0; text-align: center;">🔧 Linh Kiện Bị Ảnh Hưởng Nhiều Nhất</h3>
                        ${Object.entries(componentStats)
                            .sort(([,a], [,b]) => b - a)
                            .slice(0, 5)
                            .map(([component, count], idx) => `
                                <div style="margin: 15px 0; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div style="display: flex; align-items: center;">
                                            <span style="background: ${['#e53e3e', '#f6ad55', '#4299e1', '#38a169', '#805ad5'][idx]}; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold;">${idx + 1}</span>
                                            <span style="font-size: 0.95em; line-height: 1.3;">${component}</span>
                                        </div>
                                        <span style="background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 15px; font-weight: bold;">${count}</span>
                                    </div>
                                </div>
                            `).join('')}
                    </div>
                </div>
                
                <!-- Khuyến nghị ưu tiên -->
                <div style="background: rgba(255,255,255,0.1); padding: 25px; border-radius: 20px; margin-bottom: 20px;">
                    <h3 style="margin: 0 0 20px 0; text-align: center;">💡 Khuyến Nghị Ưu Tiên Sửa Chữa</h3>
                    ${generatePriorityRecommendations(allErrors)}
                </div>
                
                <!-- Action buttons -->
                <div style="text-align: center; margin-top: 30px; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                    <button onclick="clearAllHistory()" style="background: rgba(220, 38, 38, 0.8); border: 2px solid rgba(220, 38, 38, 0.3); color: white; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s; flex: 1; min-width: 200px; max-width: 250px;">
                        🗑️ Xóa Tất Cả Lịch Sử
                    </button>
                    <button onclick="exportDetailedReport()" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s; flex: 1; min-width: 200px; max-width: 250px;">
                        📊 Xuất Báo Cáo Chi Tiết
                    </button>
                    <button onclick="showRepairPriorityGuide()" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s; flex: 1; min-width: 200px; max-width: 250px;">
                        🛠️ Hướng Dẫn Ưu Tiên Sửa Chữa
                    </button>
                    <button onclick="showCostEstimate()" style="background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.3); color: white; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: all 0.3s; flex: 1; min-width: 200px; max-width: 250px;">
                        💰 Ước Tính Chi Phí
                    </button>
                </div>
            `;
            
            const resultsDiv = document.getElementById('analysisResults');
            resultsDiv.appendChild(summaryDiv);
        }

        // Tạo khuyến nghị ưu tiên
        function generatePriorityRecommendations(errors) {
            const criticalErrors = errors.filter(e => e.data.severity === 'critical');
            const highErrors = errors.filter(e => e.data.severity === 'high');
            const mediumErrors = errors.filter(e => e.data.severity === 'medium');
            
            let recommendations = '';
            
            if (criticalErrors.length > 0) {
                recommendations += `
                    <div style="margin: 15px 0; padding: 20px; background: rgba(229, 62, 62, 0.2); border-left: 5px solid #e53e3e; border-radius: 10px;">
                        <h4 style="color: #e53e3e; margin: 0 0 15px 0; display: flex; align-items: center;">
                            🚨 KHẨN CẤP - Cần sửa chữa ngay lập tức
                        </h4>
                        <div style="display: grid; gap: 10px;">
                            ${criticalErrors.slice(0, 3).map((error, idx) => `
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <div style="font-weight: bold; margin-bottom: 5px;">${error.data.vietnameseName}</div>
                                        <div style="font-size: 0.9em; opacity: 0.8;">Linh kiện: ${error.data.component}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.9em; opacity: 0.8;">Độ tin cậy</div>
                                        <div style="font-weight: bold;">${error.confidence}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${criticalErrors.length > 3 ? `<div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">... và ${criticalErrors.length - 3} lỗi nghiêm trọng khác</div>` : ''}
                    </div>
                `;
            }
            
            if (highErrors.length > 0) {
                recommendations += `
                    <div style="margin: 15px 0; padding: 20px; background: rgba(246, 173, 85, 0.2); border-left: 5px solid #f6ad55; border-radius: 10px;">
                        <h4 style="color: #c05621; margin: 0 0 15px 0; display: flex; align-items: center;">
                            ⚠️ CAO - Nên sửa chữa trong tuần này
                        </h4>
                        <div style="display: grid; gap: 10px;">
                            ${highErrors.slice(0, 3).map((error, idx) => `
                                <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <div style="font-weight: bold; margin-bottom: 5px;">${error.data.vietnameseName}</div>
                                        <div style="font-size: 0.9em; opacity: 0.8;">Linh kiện: ${error.data.component}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.9em; opacity: 0.8;">Độ tin cậy</div>
                                        <div style="font-weight: bold;">${error.confidence}%</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        ${highErrors.length > 3 ? `<div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">... và ${highErrors.length - 3} lỗi mức cao khác</div>` : ''}
                    </div>
                `;
            }
            
            if (mediumErrors.length > 0) {
                recommendations += `
                    <div style="margin: 15px 0; padding: 20px; background: rgba(214, 158, 46, 0.2); border-left: 5px solid #d69e2e; border-radius: 10px;">
                        <h4 style="color: #b7791f; margin: 0 0 15px 0; display: flex; align-items: center;">
                            📋 TRUNG BÌNH - Theo dõi và lên kế hoạch sửa chữa
                        </h4>
                        <div style="font-size: 0.95em; opacity: 0.9;">
                            Có ${mediumErrors.length} lỗi mức trung bình cần được theo dõi. Nên kiểm tra định kỳ và sửa chữa khi có thời gian.
                        </div>
                    </div>
                `;
            }
            
            return recommendations || '<div style="text-align: center; color: #68d391; font-size: 1.1em;">✅ Không có lỗi nghiêm trọng nào cần ưu tiên!</div>';
        }

        // Hiển thị hướng dẫn sửa chữa chi tiết
        function showRepairGuide(errorKey) {
            const errorData = errorDatabase[errorKey];
            if (!errorData) return;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 25px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, ${getSeverityColor(errorData.severity)}, ${getSeverityColorLight(errorData.severity)}); color: white; padding: 30px; border-radius: 25px 25px 0 0; position: sticky; top: 0; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; font-size: 1.8em;">🛠️ Hướng Dẫn Sửa Chữa Chi Tiết</h2>
                                <h3 style="margin: 0; opacity: 0.9; font-size: 1.3em;">${errorData.vietnameseName}</h3>
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                    </div>
                    
                    <div style="padding: 40px;">
                        <!-- Thông tin cơ bản -->
                        <div style="background: #f8f9fa; padding: 25px; border-radius: 20px; margin-bottom: 30px;">
                            <h3 style="color: #2d3748; margin: 0 0 20px 0; display: flex; align-items: center;">
                                <span style="background: ${getSeverityColor(errorData.severity)}; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2em;">ℹ️</span>
                                Thông Tin Cơ Bản
                            </h3>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div>
                                    <strong>🔧 Linh kiện bị lỗi:</strong><br>
                                    <span style="color: #4a5568; font-size: 1.1em;">${errorData.component}</span>
                                </div>
                                <div>
                                    <strong>📍 Vị trí trên board:</strong><br>
                                    <span style="color: #4a5568; font-size: 1.1em;">${errorData.location}</span>
                                </div>
                            </div>
                            <div>
                                <strong>📋 Mô tả chi tiết:</strong><br>
                                <span style="color: #4a5568; font-size: 1.05em; line-height: 1.6;">${errorData.description}</span>
                            </div>
                        </div>
                        
                        <!-- Triệu chứng -->
                        <div style="background: #fff3cd; padding: 25px; border-radius: 20px; margin-bottom: 30px; border-left: 5px solid #ffc107;">
                            <h3 style="color: #856404; margin: 0 0 20px 0; display: flex; align-items: center;">
                                <span style="background: #ffc107; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2em;">🔍</span>
                                Triệu Chứng Nhận Biết
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                ${errorData.symptoms ? errorData.symptoms.map((symptom, idx) => `
                                    <div style="display: flex; align-items: center; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                                        <span style="background: #ffc107; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 0.9em; font-weight: bold;">${idx + 1}</span>
                                        <span style="color: #856404; font-size: 1.05em;">${symptom}</span>
                                    </div>
                                `).join('') : '<div style="color: #856404;">Không có thông tin triệu chứng</div>'}
                            </div>
                        </div>
                        
                        <!-- Quy trình chẩn đoán -->
                        ${errorData.diagnosis ? `
                            <div style="background: #e7f3ff; padding: 25px; border-radius: 20px; margin-bottom: 30px; border-left: 5px solid #0066cc;">
                                <h3 style="color: #004085; margin: 0 0 20px 0; display: flex; align-items: center;">
                                    <span style="background: #0066cc; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2em;">🔬</span>
                                    Quy Trình Chẩn Đoán Chi Tiết
                                </h3>
                                <div style="display: grid; gap: 20px;">
                                    ${Object.entries(errorData.diagnosis).map(([step, instruction], idx) => `
                                        <div style="display: flex; align-items: flex-start; padding: 20px; background: rgba(255,255,255,0.8); border-radius: 15px; border-left: 4px solid #0066cc;">
                                            <div style="background: #0066cc; color: white; border-radius: 50%; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-weight: bold; flex-shrink: 0;">${idx + 1}</div>
                                            <div>
                                                <div style="font-weight: bold; color: #004085; margin-bottom: 8px; text-transform: capitalize;">${step.replace('step', 'Bước ')}</div>
                                                <div style="color: #004085; line-height: 1.6; font-size: 1.05em;">${instruction}</div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Nguyên nhân -->
                        <div style="background: #f8d7da; padding: 25px; border-radius: 20px; margin-bottom: 30px; border-left: 5px solid #dc3545;">
                            <h3 style="color: #721c24; margin: 0 0 20px 0; display: flex; align-items: center;">
                                <span style="background: #dc3545; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2em;">⚠️</span>
                                Nguyên Nhân Có Thể
                            </h3>
                            <div style="display: grid; gap: 12px;">
                                ${errorData.causes ? errorData.causes.map((cause, idx) => `
                                    <div style="display: flex; align-items: center; padding: 12px; background: rgba(255,255,255,0.7); border-radius: 10px;">
                                        <span style="background: #dc3545; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 0.9em; font-weight: bold;">${idx + 1}</span>
                                        <span style="color: #721c24; font-size: 1.05em;">${cause}</span>
                                    </div>
                                `).join('') : '<div style="color: #721c24;">Cần chẩn đoán thêm để xác định nguyên nhân</div>'}
                            </div>
                        </div>
                        
                        <!-- Giải pháp sửa chữa -->
                        <div style="background: #d1ecf1; padding: 25px; border-radius: 20px; margin-bottom: 30px; border-left: 5px solid #17a2b8;">
                            <h3 style="color: #0c5460; margin: 0 0 20px 0; display: flex; align-items: center;">
                                <span style="background: #17a2b8; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2em;">🛠️</span>
                                Giải Pháp Sửa Chữa (Theo Thứ Tự Ưu Tiên)
                            </h3>
                            <div style="display: grid; gap: 15px;">
                                ${errorData.repairSolution ? errorData.repairSolution.map((solution, idx) => {
                                    const difficulty = idx === 0 ? 'Dễ' : idx === 1 ? 'Trung bình' : idx === 2 ? 'Khó' : 'Rất khó';
                                    const difficultyColor = idx === 0 ? '#28a745' : idx === 1 ? '#ffc107' : idx === 2 ? '#fd7e14' : '#dc3545';
                                    const estimatedTime = idx === 0 ? '15-30 phút' : idx === 1 ? '1-2 giờ' : idx === 2 ? '2-4 giờ' : '4+ giờ';
                                    const estimatedCost = idx === 0 ? '50-200k' : idx === 1 ? '200-500k' : idx === 2 ? '500k-1tr' : '1-3tr';
                                    
                                    return `
                                        <div style="padding: 20px; background: rgba(255,255,255,0.8); border-radius: 15px; border-left: 4px solid #17a2b8;">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; flex-wrap: wrap; gap: 10px;">
                                                <div style="display: flex; align-items: center;">
                                                    <span style="background: #17a2b8; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-weight: bold;">${idx + 1}</span>
                                                    <div>
                                                        <div style="font-weight: bold; color: #0c5460; font-size: 1.1em; margin-bottom: 5px;">${solution}</div>
                                                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                                                            <span style="background: ${difficultyColor}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em; font-weight: bold;">
                                                                Độ khó: ${difficulty}
                                                            </span>
                                                            <span style="background: #6c757d; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">
                                                                ⏱️ ${estimatedTime}
                                                            </span>
                                                            <span style="background: #007bff; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">
                                                                💰 ${estimatedCost}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('') : '<div style="color: #0c5460;">Cần chẩn đoán chuyên sâu để đưa ra giải pháp phù hợp</div>'}
                            </div>
                        </div>
                        
                        <!-- Lưu ý quan trọng -->
                        <div style="background: linear-gradient(135deg, #ff6b6b, #feca57); color: white; padding: 25px; border-radius: 20px; margin-bottom: 30px;">
                            <h3 style="margin: 0 0 15px 0; display: flex; align-items: center;">
                                <span style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2em;">⚡</span>
                                Lưu Ý Quan Trọng
                            </h3>
                            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                    <li>Luôn sao lưu dữ liệu trước khi sửa chữa</li>
                                    <li>Sử dụng linh kiện chính hãng hoặc tương thích</li>
                                    <li>Kiểm tra bảo hành trước khi can thiệp</li>
                                    <li>Nếu không có kinh nghiệm, hãy đến cửa hàng uy tín</li>
                                    <li>Một số lỗi có thể cần thiết bị chuyên dụng để sửa</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="text-align: center; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                            <button onclick="printRepairGuide('${errorKey}')" style="background: linear-gradient(135deg, #28a745, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 300px;">
                                🖨️ In Hướng Dẫn
                            </button>
                            <button onclick="saveRepairGuide('${errorKey}')" style="background: linear-gradient(135deg, #007bff, #6610f2); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 300px;">
                                💾 Lưu Hướng Dẫn
                            </button>
                            <button onclick="shareRepairGuide('${errorKey}')" style="background: linear-gradient(135deg, #17a2b8, #20c997); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 300px;">
                                📤 Chia Sẻ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal khi click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // ESC key để đóng modal
            const handleEsc = function(e) {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // Hiển thị quy trình chẩn đoán
        function showDiagnosticSteps(errorKey) {
            const errorData = errorDatabase[errorKey];
            if (!errorData || !errorData.diagnosis) {
                showNotification('Không có quy trình chẩn đoán chi tiết cho lỗi này', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 25px; max-width: 800px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #4299e1, #3182ce); color: white; padding: 30px; border-radius: 25px 25px 0 0; position: sticky; top: 0; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; font-size: 1.8em;">🔬 Quy Trình Chẩn Đoán</h2>
                                <h3 style="margin: 0; opacity: 0.9; font-size: 1.3em;">${errorData.vietnameseName}</h3>
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                    </div>
                    
                    <div style="padding: 40px;">
                        <div style="background: #e7f3ff; padding: 25px; border-radius: 20px; margin-bottom: 30px; border-left: 5px solid #4299e1;">
                            <h3 style="color: #2c5282; margin: 0 0 15px 0;">📋 Thông Tin Chung</h3>
                            <div style="color: #2c5282; line-height: 1.6;">
                                <strong>Linh kiện:</strong> ${errorData.component}<br>
                                <strong>Vị trí:</strong> ${errorData.location}<br>
                                <strong>Mức độ:</strong> ${getSeverityText(errorData.severity)}
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 25px;">
                            ${Object.entries(errorData.diagnosis).map(([step, instruction], idx) => `
                                <div style="border: 2px solid #e2e8f0; border-radius: 20px; overflow: hidden; transition: all 0.3s ease;">
                                    <div style="background: linear-gradient(135deg, #4299e1, #63b3ed); color: white; padding: 20px; display: flex; align-items: center;">
                                        <div style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 1.5em; font-weight: bold;">
                                            ${idx + 1}
                                        </div>
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; font-size: 1.3em;">${step.replace('step', 'Bước ')}</h4>
                                            <div style="opacity: 0.9;">Thời gian ước tính: ${getEstimatedTime(idx)} phút</div>
                                        </div>
                                    </div>
                                    <div style="padding: 25px; background: white;">
                                        <div style="color: #2d3748; font-size: 1.1em; line-height: 1.7; margin-bottom: 20px;">
                                            ${instruction}
                                        </div>
                                        
                                        ${getDetailedInstructions(errorKey, idx)}
                                        
                                        <div style="background: #f7fafc; padding: 15px; border-radius: 10px; margin-top: 15px;">
                                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                                                <span style="background: #4299e1; color: white; border-radius: 50%; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 0.9em;">💡</span>
                                                <strong style="color: #2d3748;">Mẹo chuyên nghiệp:</strong>
                                            </div>
                                            <div style="color: #4a5568; font-size: 0.95em; line-height: 1.6;">
                                                ${getProfessionalTip(errorKey, idx)}
                                            </div>
                                        </div>
                                        
                                        <div style="margin-top: 15px; text-align: center;">
                                            <button onclick="markStepCompleted(this, ${idx})" style="background: linear-gradient(135deg, #48bb78, #38a169); color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: all 0.3s;">
                                                ✓ Đánh Dấu Hoàn Thành
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="margin-top: 30px; text-align: center; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                            <button onclick="generateDiagnosticReport('${errorKey}')" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                📊 Tạo Báo Cáo Chẩn Đoán
                            </button>
                            <button onclick="printDiagnosticSteps('${errorKey}')" style="background: linear-gradient(135deg, #f093fb, #f5576c); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                🖨️ In Quy Trình
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal khi click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Lấy thời gian ước tính cho từng bước
        function getEstimatedTime(stepIndex) {
            const times = [15, 30, 45, 60];
            return times[stepIndex] || 30;
        }

        // Lấy hướng dẫn chi tiết cho từng bước
        function getDetailedInstructions(errorKey, stepIndex) {
            const instructions = {
                'watchdog_timeout': [
                    'Sử dụng 3uTools hoặc iMazing để kiểm tra nhiệt độ CPU trong thời gian thực. Nhiệt độ bình thường: 35-45°C khi idle, 60-70°C khi load.',
                    'Chạy MemTest86 hoặc sử dụng Xcode Instruments để test RAM. Kiểm tra memory leaks và bad sectors.',
                    'Sử dụng multimeter để đo PPVDD_MAIN rail (thường 1.8V). Kiểm tra tụ lọc C1234, C5678 xung quanh CPU.',
                    'Đo điện trở các tụ tantalum và ceramic capacitors. Giá trị bình thường: 10-100 ohms.'
                ],
                'thermal_shutdown': [
                    'Sử dụng FLIR thermal camera hoặc infrared thermometer. Kiểm tra hotspots trên board.',
                    'Tháo heatsink/thermal pad, kiểm tra thermal paste. Thay bằng Arctic MX-4 hoặc Thermal Grizzly.',
                    'Sử dụng DC power supply để cấp nguồn riêng cho thermal sensor, đo output voltage.',
                    'Kiểm tra thermal throttling events trong Console app (macOS) hoặc syslog.'
                ],
                'nand_panic': [
                    'Sử dụng NAND programmer (RT809H, TL866) để scan bad blocks và read flash info.',
                    'Kiểm tra ANS controller communication qua I2C/SPI interface.',
                    'Test read/write speed bằng Blackmagic Disk Speed Test hoặc CrystalDiskMark.',
                    'Dump firmware từ NAND và check integrity với hex editor.'
                ]
            };
            
            const errorInstructions = instructions[errorKey];
            if (errorInstructions && errorInstructions[stepIndex]) {
                return `
                    <div style="background: #edf2f7; padding: 20px; border-radius: 15px; border-left: 4px solid #4299e1;">
                        <h5 style="color: #2d3748; margin: 0 0 15px 0;">🔧 Hướng dẫn chi tiết:</h5>
                        <div style="color: #4a5568; line-height: 1.6;">
                            ${errorInstructions[stepIndex]}
                        </div>
                    </div>
                `;
            }
            return '';
        }

        // Lấy mẹo chuyên nghiệp
        function getProfessionalTip(errorKey, stepIndex) {
            const tips = {
                'watchdog_timeout': [
                    'Luôn kiểm tra nhiệt độ trong điều kiện stress test (chạy benchmark) để phát hiện thermal throttling.',
                    'Memory errors thường xuất hiện khi RAM quá nóng. Kiểm tra thermal pad của RAM.',
                    'PPVDD_MAIN rail rất quan trọng - nếu voltage drop quá 5%, CPU sẽ unstable.',
                    'Tụ lọc nguồn thường bị hỏng do aging. Thay toàn bộ cụm tụ xung quanh CPU.'
                ],
                'thermal_shutdown': [
                    'Thermal camera cho thấy chính xác điểm nóng nhất. Thường là CPU, GPU, hoặc charging IC.',
                    'Thermal paste chất lượng cao có thể giảm 10-15°C so với paste gốc.',
                    'Thermal sensor có thể bị offset. Calibrate bằng cách so với nhiệt độ thực tế.',
                    'Thermal throttling events được log trong system. Phân tích để tìm pattern.'
                ],
                'nand_panic': [
                    'Bad blocks tăng nhanh là dấu hiệu NAND sắp hết tuổi thọ. Backup ngay lập tức.',
                    'ANS controller failure thường do power surge. Kiểm tra power rails trước.',
                    'Slow storage có thể do wear leveling algorithm failing. Cần professional tools.',
                    'Firmware corruption có thể recover được nếu có backup firmware tương thích.'
                ]
            };
            
            const errorTips = tips[errorKey];
            return errorTips && errorTips[stepIndex] ? errorTips[stepIndex] : 'Luôn cẩn thận và backup dữ liệu trước khi thực hiện.';

        }

        // Đánh dấu bước hoàn thành
        function markStepCompleted(button, stepIndex) {
            button.style.background = 'linear-gradient(135deg, #38a169, #48bb78)';
            button.innerHTML = '✅ Đã Hoàn Thành';
            button.disabled = true;
            
            // Animation effect
            button.style.transform = 'scale(0.95)';
            setTimeout(() => {
                button.style.transform = 'scale(1)';
            }, 150);
            
            // Lưu progress
            const completedSteps = JSON.parse(localStorage.getItem('diagnosticProgress') || '{}');
            const currentError = button.closest('[style*="position: fixed"]').querySelector('h3').textContent;
            if (!completedSteps[currentError]) completedSteps[currentError] = [];
            if (!completedSteps[currentError].includes(stepIndex)) {
                completedSteps[currentError].push(stepIndex);
            }
            localStorage.setItem('diagnosticProgress', JSON.stringify(completedSteps));
            
            showNotification(`Bước ${stepIndex + 1} đã được đánh dấu hoàn thành!`, 'success');
        }

        // Tạo báo cáo chẩn đoán
        function generateDiagnosticReport(errorKey) {
            const errorData = errorDatabase[errorKey];
            const completedSteps = JSON.parse(localStorage.getItem('diagnosticProgress') || '{}');
            const currentError = errorData.vietnameseName;
            const completed = completedSteps[currentError] || [];
            
            const reportContent = `
                <div style="font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 40px; background: white;">
                    <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #4299e1; padding-bottom: 20px;">
                        <h1 style="color: #2d3748; margin: 0 0 10px 0;">📊 BÁO CÁO CHẨN ĐOÁN</h1>
                        <h2 style="color: #4299e1; margin: 0;">${errorData.vietnameseName}</h2>
                        <p style="color: #666; margin: 10px 0 0 0;">Ngày tạo: ${new Date().toLocaleString('vi-VN')}</p>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2d3748; border-left: 4px solid #4299e1; padding-left: 15px;">Thông Tin Lỗi</h3>
                        <div style="background: #f7fafc; padding: 20px; border-radius: 10px;">
                            <p><strong>Linh kiện:</strong> ${errorData.component}</p>
                            <p><strong>Vị trí:</strong> ${errorData.location}</p>
                            <p><strong>Mức độ nghiêm trọng:</strong> ${getSeverityText(errorData.severity)}</p>
                            <p><strong>Mô tả:</strong> ${errorData.description}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2d3748; border-left: 4px solid #48bb78; padding-left: 15px;">Tiến Độ Chẩn Đoán</h3>
                        <div style="background: #f0fff4; padding: 20px; border-radius: 10px;">
                            <p><strong>Tổng số bước:</strong> ${Object.keys(errorData.diagnosis || {}).length}</p>
                            <p><strong>Đã hoàn thành:</strong> ${completed.length} bước</p>
                            <p><strong>Tiến độ:</strong> ${Math.round((completed.length / Object.keys(errorData.diagnosis || {}).length) * 100)}%</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2d3748; border-left: 4px solid #f6ad55; padding-left: 15px;">Chi Tiết Các Bước</h3>
                        ${Object.entries(errorData.diagnosis || {}).map(([step, instruction], idx) => `
                            <div style="margin: 15px 0; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; ${completed.includes(idx) ? 'background: #f0fff4; border-color: #48bb78;' : 'background: #fff5f5; border-color: #feb2b2;'}">
                                <h4 style="margin: 0 0 10px 0; color: ${completed.includes(idx) ? '#38a169' : '#e53e3e'};">
                                    ${completed.includes(idx) ? '✅' : '❌'} ${step.replace('step', 'Bước ')}
                                </h4>
                                <p style="margin: 0; color: #4a5568;">${instruction}</p>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #2d3748; border-left: 4px solid #805ad5; padding-left: 15px;">Khuyến Nghị</h3>
                        <div style="background: #faf5ff; padding: 20px; border-radius: 10px;">
                            ${completed.length === Object.keys(errorData.diagnosis || {}).length ? 
                                '<p style="color: #38a169;"><strong>✅ Hoàn thành tất cả bước chẩn đoán!</strong> Có thể tiến hành sửa chữa theo hướng dẫn.</p>' :
                                '<p style="color: #e53e3e;"><strong>⚠️ Chưa hoàn thành chẩn đoán.</strong> Cần thực hiện thêm các bước còn lại để có kết luận chính xác.</p>'
                            }
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <p style="color: #666; font-size: 0.9em;">Báo cáo được tạo bởi AI Panic Log Analyzer</p>
                    </div>
                </div>
            `;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Báo Cáo Chẩn Đoán - ${errorData.vietnameseName}</title>
                    <meta charset="UTF-8">
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${reportContent}
                    <div class="no-print" style="text-align: center; margin: 20px;">
                        <button onclick="window.print()" style="background: #4299e1; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; margin-right: 15px;">🖨️ In Báo Cáo</button>
                        <button onclick="window.close()" style="background: #e53e3e; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold;">❌ Đóng</button>
                    </div>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        // Hiển thị chẩn đoán tổng quát
        function showGeneralDiagnostic() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 25px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #38a169, #48bb78); color: white; padding: 30px; border-radius: 25px 25px 0 0; position: sticky; top: 0; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; font-size: 1.8em;">🔍 Chẩn Đoán Tổng Quát</h2>
                                <p style="margin: 0; opacity: 0.9; font-size: 1.1em;">Hướng dẫn chẩn đoán khi không phát hiện lỗi cụ thể</p>
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                    </div>
                    
                    <div style="padding: 40px;">
                        <div style="background: #e6fffa; padding: 25px; border-radius: 20px; margin-bottom: 30px; border-left: 5px solid #38a169;">
                            <h3 style="color: #234e52; margin: 0 0 15px 0;">📋 Các Bước Chẩn Đoán Cơ Bản</h3>
                            <div style="color: #234e52; line-height: 1.6;">
                                Khi không phát hiện lỗi panic cụ thể, hãy thực hiện các bước sau để chẩn đoán sâu hơn:
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 25px;">
                            <div style="border: 2px solid #e2e8f0; border-radius: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #4299e1, #63b3ed); color: white; padding: 20px; display: flex; align-items: center;">
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 1.5em; font-weight: bold;">1</div>
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; font-size: 1.3em;">Kiểm Tra Phần Mềm</h4>
                                        <div style="opacity: 0.9;">Thời gian: 15-30 phút</div>
                                    </div>
                                </div>
                                <div style="padding: 25px; background: white;">
                                    <ul style="color: #2d3748; line-height: 1.7; margin: 0; padding-left: 20px;">
                                        <li>Khởi động lại thiết bị và kiểm tra xem lỗi có lặp lại không</li>
                                        <li>Cập nhật iOS/macOS lên phiên bản mới nhất</li>
                                        <li>Gỡ cài đặt các ứng dụng được cài đặt gần đây</li>
                                        <li>Reset cài đặt mạng và cài đặt chung</li>
                                        <li>Kiểm tra dung lượng lưu trữ còn lại (cần ít nhất 10% trống)</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="border: 2px solid #e2e8f0; border-radius: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #f6ad55, #fd7e14); color: white; padding: 20px; display: flex; align-items: center;">
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 1.5em; font-weight: bold;">2</div>
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; font-size: 1.3em;">Kiểm Tra Phần Cứng Cơ Bản</h4>
                                        <div style="opacity: 0.9;">Thời gian: 30-45 phút</div>
                                    </div>
                                </div>
                                <div style="padding: 25px; background: white;">
                                    <ul style="color: #2d3748; line-height: 1.7; margin: 0; padding-left: 20px;">
                                        <li>Kiểm tra nhiệt độ thiết bị - không nên quá nóng khi sử dụng</li>
                                        <li>Test pin: kiểm tra % pin, thời gian sử dụng, tốc độ sạc</li>
                                        <li>Kiểm tra tất cả cổng kết nối (Lightning, USB-C, headphone jack)</li>
                                        <li>Test camera, mic, loa, cảm biến (Touch ID/Face ID)</li>
                                        <li>Kiểm tra màn hình có dead pixel, ghost touch không</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="border: 2px solid #e2e8f0; border-radius: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #e53e3e, #fc8181); color: white; padding: 20px; display: flex; align-items: center;">
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 1.5em; font-weight: bold;">3</div>
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; font-size: 1.3em;">Chẩn Đoán Chuyên Sâu</h4>
                                        <div style="opacity: 0.9;">Thời gian: 1-2 giờ</div>
                                    </div>
                                </div>
                                <div style="padding: 25px; background: white;">
                                    <ul style="color: #2d3748; line-height: 1.7; margin: 0; padding-left: 20px;">
                                        <li>Chạy Apple Diagnostics (giữ D khi khởi động)</li>
                                        <li>Sử dụng 3uTools để kiểm tra chi tiết phần cứng</li>
                                        <li>Kiểm tra log hệ thống trong Console app</li>
                                        <li>Test stress với benchmark apps (Geekbench, 3DMark)</li>
                                        <li>Kiểm tra kết nối mạng và Bluetooth</li>
                                    </ul>
                                </div>
                            </div>
                            
                            <div style="border: 2px solid #e2e8f0; border-radius: 20px; overflow: hidden;">
                                <div style="background: linear-gradient(135deg, #805ad5, #b794f6); color: white; padding: 20px; display: flex; align-items: center;">
                                    <div style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 1.5em; font-weight: bold;">4</div>
                                    <div>
                                        <h4 style="margin: 0 0 5px 0; font-size: 1.3em;">Phân Tích Log Chi Tiết</h4>
                                        <div style="opacity: 0.9;">Thời gian: 45-60 phút</div>
                                    </div>
                                </div>
                                <div style="padding: 25px; background: white;">
                                    <div style="color: #2d3748; line-height: 1.7; margin-bottom: 20px;">
                                        Nếu các bước trên không phát hiện vấn đề, hãy phân tích panic log thủ công:
                                    </div>
                                    <ul style="color: #2d3748; line-height: 1.7; margin: 0; padding-left: 20px;">
                                        <li>Tìm kiếm keywords: "panic", "fault", "exception", "crash"</li>
                                        <li>Xem backtrace để xác định process gây lỗi</li>
                                        <li>Kiểm tra memory addresses và register values</li>
                                        <li>Phân tích timestamp để tìm pattern</li>
                                        <li>So sánh với panic logs tương tự trên internet</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 25px; border-radius: 20px; margin: 30px 0;">
                            <h3 style="margin: 0 0 15px 0; display: flex; align-items: center;">
                                <span style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px; font-size: 1.2em;">💡</span>
                                Mẹo Chuyên Nghiệp
                            </h3>
                            <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                                <ul style="margin: 0; padding-left: 20px; line-height: 1.8;">
                                    <li>Panic logs không phát hiện lỗi có thể do lỗi phần mềm tạm thời</li>
                                    <li>Hãy thu thập nhiều panic logs để tìm pattern chung</li>
                                    <li>Kiểm tra xem lỗi có xảy ra trong điều kiện cụ thể không (sạc, nóng, app nào đó)</li>
                                    <li>Một số lỗi hardware cần thiết bị chuyên dụng để phát hiện</li>
                                    <li>Khi nghi ngờ hardware, hãy đến cửa hàng uy tín để kiểm tra</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div style="text-align: center; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                            <button onclick="downloadGeneralGuide()" style="background: linear-gradient(135deg, #38a169, #48bb78); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 300px;">
                                📥 Tải Hướng Dẫn PDF
                            </button>
                            <button onclick="showAdvancedTools()" style="background: linear-gradient(135deg, #4299e1, #3182ce); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 300px;">
                                🛠️ Công Cụ Chuyên Nghiệp
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal khi click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Hiển thị công cụ chuyên nghiệp
        function showAdvancedTools() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10001; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 25px; max-width: 1000px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #4299e1, #3182ce); color: white; padding: 30px; border-radius: 25px 25px 0 0; position: sticky; top: 0; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; font-size: 1.8em;">🛠️ Công Cụ Chuyên Nghiệp</h2>
                                <p style="margin: 0; opacity: 0.9; font-size: 1.1em;">Danh sách công cụ chẩn đoán và sửa chữa chuyên nghiệp</p>
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                    </div>
                    
                    <div style="padding: 40px;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px;">
                            <!-- Software Tools -->
                            <div style="background: #f0f9ff; padding: 25px; border-radius: 20px; border-left: 5px solid #0ea5e9;">
                                <h3 style="color: #0c4a6e; margin: 0 0 20px 0; display: flex; align-items: center;">
                                    <span style="background: #0ea5e9; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">💻</span>
                                    Phần Mềm Chẩn Đoán
                                </h3>
                                <div style="space-y: 15px;">
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #0c4a6e;">3uTools</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Công cụ toàn diện cho iOS: backup, flash, jailbreak, hardware info</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">Free</span>
                                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Windows</span>
                                        </div>
                                    </div>
                                    
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #0c4a6e;">iMazing</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Quản lý iOS chuyên nghiệp, backup, logs analysis</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">Paid</span>
                                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Cross-platform</span>
                                        </div>
                                    </div>
                                    
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #0c4a6e;">checkra1n</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Jailbreak tool, có thể dùng để chạy diagnostic tools</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">Free</span>
                                            <span style="background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Advanced</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hardware Tools -->
                            <div style="background: #fef7ff; padding: 25px; border-radius: 20px; border-left: 5px solid #a855f7;">
                                <h3 style="color: #581c87; margin: 0 0 20px 0; display: flex; align-items: center;">
                                    <span style="background: #a855f7; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">🔧</span>
                                    Thiết Bị Phần Cứng
                                </h3>
                                <div style="space-y: 15px;">
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #581c87;">DC Power Supply</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Cung cấp nguồn chính xác để test các rail nguồn</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$200-500</span>
                                            <span style="background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Professional</span>
                                        </div>
                                    </div>
                                    
                                    <div style="background: white; padding:15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #581c87;">Digital Multimeter</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Đo điện áp, dòng điện, điện trở chính xác</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$50-200</span>
                                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Essential</span>
                                        </div>
                                    </div>
                                    
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #581c87;">Thermal Camera</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">FLIR hoặc tương tự để phát hiện hotspots</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$1000+</span>
                                            <span style="background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Expert</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- NAND Tools -->
                            <div style="background: #fff7ed; padding: 25px; border-radius: 20px; border-left: 5px solid #ea580c;">
                                <h3 style="color: #9a3412; margin: 0 0 20px 0; display: flex; align-items: center;">
                                    <span style="background: #ea580c; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">💾</span>
                                    NAND/Flash Tools
                                </h3>
                                <div style="space-y: 15px;">
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #9a3412;">RT809H Programmer</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">NAND flash programmer, đọc/ghi NAND trực tiếp</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$300-500</span>
                                            <span style="background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Professional</span>
                                        </div>
                                    </div>
                                    
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #9a3412;">Easy JTAG Plus</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">JTAG/ISP programmer cho mobile devices</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #fee2e2; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$800+</span>
                                            <span style="background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Expert</span>
                                        </div>
                                    </div>
                                    
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #9a3412;">HDD Regenerator</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Phục hồi bad sectors, test storage health</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$50</span>
                                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Software</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Microscopy -->
                            <div style="background: #f0fdf4; padding: 25px; border-radius: 20px; border-left: 5px solid #16a34a;">
                                <h3 style="color: #14532d; margin: 0 0 20px 0; display: flex; align-items: center;">
                                    <span style="background: #16a34a; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">🔬</span>
                                    Kính Hiển Vi & Hàn
                                </h3>
                                <div style="space-y: 15px;">
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #14532d;">Stereo Microscope</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Kính hiển vi 2 mắt, zoom 10-40x cho vi hàn</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$500-2000</span>
                                            <span style="background: #fecaca; color: #991b1b; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Professional</span>
                                        </div>
                                    </div>
                                    
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #14532d;">Hot Air Station</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Trạm khí nóng cho BGA rework, chip replacement</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #fef3c7; color: #92400e; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$200-800</span>
                                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Essential</span>
                                        </div>
                                    </div>
                                    
                                    <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                                        <h4 style="margin: 0 0 8px 0; color: #14532d;">Soldering Iron</h4>
                                        <p style="margin: 0; color: #475569; font-size: 0.95em;">Mỏ hàn chính xác, nhiệt độ điều chỉnh được</p>
                                        <div style="margin-top: 10px;">
                                            <span style="background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 12px; font-size: 0.8em;">$50-300</span>
                                            <span style="background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px;">Basic</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #1f2937, #374151); color: white; padding: 30px; border-radius: 20px; margin: 30px 0;">
                            <h3 style="margin: 0 0 20px 0; text-align: center; font-size: 1.5em;">🎓 Khuyến Nghị Theo Trình Độ</h3>
                            
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                                    <h4 style="margin: 0 0 15px 0; color: #60a5fa;">👶 Người Mới Bắt Đầu</h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 0.95em;">
                                        <li>3uTools (free)</li>
                                        <li>Digital Multimeter cơ bản</li>
                                        <li>Screwdriver set</li>
                                        <li>Anti-static wrist strap</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                                    <h4 style="margin: 0 0 15px 0; color: #fbbf24;">🔧 Trung Cấp</h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 0.95em;">
                                        <li>iMazing Pro</li>
                                        <li>DC Power Supply</li>
                                        <li>Hot Air Station</li>
                                        <li>Stereo Microscope</li>
                                    </ul>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                                    <h4 style="margin: 0 0 15px 0; color: #f87171;">🚀 Chuyên Nghiệp</h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 0.95em;">
                                        <li>RT809H Programmer</li>
                                        <li>Thermal Camera</li>
                                        <li>Easy JTAG Plus</li>
                                        <li>Professional Rework Station</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                            <button onclick="downloadToolsList()" style="background: linear-gradient(135deg, #4299e1, #3182ce); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                📥 Tải Danh Sách PDF
                            </button>
                            <button onclick="showToolsComparison()" style="background: linear-gradient(135deg, #8b5cf6, #a78bfa); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                ⚖️ So Sánh Công Cụ
                            </button>
                            <button onclick="showBuyingGuide()" style="background: linear-gradient(135deg, #10b981, #34d399); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                🛒 Hướng Dẫn Mua
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal khi click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Hiển thị hướng dẫn ưu tiên sửa chữa
        function showRepairPriorityGuide() {
            const allErrors = analysisResults.flatMap(result => result.errors);
            if (allErrors.length === 0) {
                showNotification('Chưa có lỗi nào được phát hiện để tạo hướng dẫn ưu tiên', 'warning');
                return;
            }
            
            // Sắp xếp theo mức độ nghiêm trọng và confidence
            const sortedErrors = allErrors.sort((a, b) => {
                const severityOrder = { 'critical': 4, 'high': 3, 'medium': 2, 'low': 1 };
                const severityDiff = severityOrder[b.data.severity] - severityOrder[a.data.severity];
                if (severityDiff !== 0) return severityDiff;
                return b.confidence - a.confidence;
            });
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 25px; max-width: 1000px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 30px; border-radius: 25px 25px 0 0; position: sticky; top: 0; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; font-size: 1.8em;">🛠️ Hướng Dẫn Ưu Tiên Sửa Chữa</h2>
                                <p style="margin: 0; opacity: 0.9; font-size: 1.1em;">Thứ tự sửa chữa được AI khuyến nghị dựa trên mức độ nghiêm trọng</p>
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                    </div>
                    
                    <div style="padding: 40px;">
                        <div style="background: linear-gradient(135deg, #fef3c7, #fde68a); padding: 25px; border-radius: 20px; margin-bottom: 30px; border-left: 5px solid #f59e0b;">
                            <h3 style="color: #92400e; margin: 0 0 15px 0; display: flex; align-items: center;">
                                <span style="background: #f59e0b; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">⚡</span>
                                Nguyên Tắc Ưu Tiên
                            </h3>
                            <div style="color: #92400e; line-height: 1.6;">
                                <strong>1. Nghiêm trọng nhất trước:</strong> Critical → High → Medium → Low<br>
                                <strong>2. Độ tin cậy cao:</strong> Ưu tiên lỗi có confidence ≥ 85%<br>
                                <strong>3. Ảnh hưởng hệ thống:</strong> Lỗi ảnh hưởng toàn bộ thiết bị được ưu tiên<br>
                                <strong>4. Chi phí - hiệu quả:</strong> Sửa lỗi dễ và rẻ trước khi tackle lỗi phức tạp
                            </div>
                        </div>
                        
                        <div style="display: grid; gap: 20px;">
                            ${sortedErrors.map((error, index) => {
                                const priorityColors = {
                                    0: { bg: '#fee2e2', border: '#dc2626', text: '#991b1b' },
                                    1: { bg: '#fed7aa', border: '#ea580c', text: '#9a3412' },
                                    2: { bg: '#fef3c7', border: '#f59e0b', text: '#92400e' }
                                };
                                const colorScheme = priorityColors[Math.min(index, 2)] || { bg: '#f3f4f6', border: '#6b7280', text: '#374151' };
                                
                                const estimatedCost = getEstimatedRepairCost(error.data.severity);
                                const estimatedTime = getEstimatedRepairTime(error.data.severity);
                                const difficultyLevel = getRepairDifficulty(error.data.severity);
                                
                                return `
                                    <div style="background: ${colorScheme.bg}; border: 2px solid ${colorScheme.border}; border-radius: 20px; overflow: hidden;">
                                        <div style="background: ${colorScheme.border}; color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                            <div style="display: flex; align-items: center;">
                                                <div style="background: rgba(255,255,255,0.2); border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; margin-right: 20px; font-size: 1.5em; font-weight: bold;">
                                                    ${index + 1}
                                                </div>
                                                <div>
                                                    <h4 style="margin: 0 0 5px 0; font-size: 1.3em;">${error.data.vietnameseName}</h4>
                                                    <div style="opacity: 0.9;">Ưu tiên: ${index === 0 ? 'KHẨN CẤP' : index === 1 ? 'CAO' : index === 2 ? 'TRUNG BÌNH' : 'THẤP'}</div>
                                                </div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 15px; margin-bottom: 5px;">
                                                    Confidence: ${error.confidence}%
                                                </div>
                                                <div style="font-size: 0.9em; opacity: 0.9;">
                                                    ${getSeverityText(error.data.severity)}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div style="padding: 25px;">
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                                    <h5 style="margin: 0 0 10px 0; color: ${colorScheme.text};">💰 Chi Phí Ước Tính</h5>
                                                    <div style="font-size: 1.2em; font-weight: bold; color: ${colorScheme.text};">${estimatedCost}</div>
                                                </div>
                                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                                    <h5 style="margin: 0 0 10px 0; color: ${colorScheme.text};">⏱️ Thời Gian</h5>
                                                    <div style="font-size: 1.2em; font-weight: bold; color: ${colorScheme.text};">${estimatedTime}</div>
                                                </div>
                                                <div style="background: white; padding: 15px; border-radius: 10px;">
                                                    <h5 style="margin: 0 0 10px 0; color: ${colorScheme.text};">🎯 Độ Khó</h5>
                                                    <div style="font-size: 1.2em; font-weight: bold; color: ${colorScheme.text};">${difficultyLevel}</div>
                                                </div>
                                            </div>
                                            
                                            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                                <h5 style="margin: 0 0 15px 0; color: ${colorScheme.text};">🔧 Linh Kiện & Vị Trí</h5>
                                                <div style="color: #4a5568; line-height: 1.6;">
                                                    <strong>Linh kiện:</strong> ${error.data.component}<br>
                                                    <strong>Vị trí:</strong> ${error.data.location}
                                                </div>
                                            </div>
                                            
                                            <div style="background: white; padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                                                <h5 style="margin: 0 0 15px 0; color: ${colorScheme.text};">🛠️ Giải Pháp Khuyến Nghị</h5>
                                                <div style="color: #4a5568; line-height: 1.6;">
                                                    ${error.data.repairSolution ? error.data.repairSolution.slice(0, 2).map((solution, idx) => 
                                                        `<div style="margin: 8px 0;"><strong>${idx + 1}.</strong> ${solution}</div>`
                                                    ).join('') : 'Cần chẩn đoán thêm'}
                                                </div>
                                            </div>
                                            
                                            <div style="text-align: center; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
                                                <button onclick="showRepairGuide('${error.key}')" style="background: linear-gradient(135deg, ${colorScheme.border}, ${colorScheme.text}); color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 180px; max-width: 250px;">
                                                    📋 Chi Tiết Sửa Chữa
                                                </button>
                                                <button onclick="markAsCompleted('${error.key}', ${index})" style="background: linear-gradient(135deg, #10b981, #34d399); color: white; border: none; padding: 12px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 180px; max-width: 250px;">
                                                    ✅ Đánh Dấu Hoàn Thành
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #1f2937, #374151); color: white; padding: 30px; border-radius: 20px; margin: 30px 0;">
                            <h3 style="margin: 0 0 20px 0; text-align: center;">💡 Lời Khuyên Chuyên Nghiệp</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                                    <h4 style="margin: 0 0 10px 0; color: #60a5fa;">🎯 Chiến Lược Sửa Chữa</h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 0.95em;">
                                        <li>Sửa lỗi critical trước để tránh hỏng thêm</li>
                                        <li>Backup dữ liệu trước khi bắt đầu</li>
                                        <li>Chuẩn bị đầy đủ linh kiện và công cụ</li>
                                        <li>Test từng bước sau khi sửa</li>
                                    </ul>
                                </div>
                                <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 15px;">
                                    <h4 style="margin: 0 0 10px 0; color: #fbbf24;">⚠️ Lưu Ý Quan Trọng</h4>
                                    <ul style="margin: 0; padding-left: 20px; line-height: 1.6; font-size: 0.95em;">
                                        <li>Một số lỗi có thể liên quan đến nhau</li>
                                        <li>Kiểm tra bảo hành trước khi sửa</li>
                                        <li>Nếu không chắc chắn, hãy hỏi chuyên gia</li>
                                        <li>Document lại quá trình sửa chữa</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                            <button onclick="generateRepairPlan()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                📋 Tạo Kế Hoạch Sửa Chữa
                            </button>
                            <button onclick="exportPriorityList()" style="background: linear-gradient(135deg, #10b981, #34d399); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                📤 Xuất Danh Sách Ưu Tiên
                            </button>
                            <button onclick="showCostBreakdown()" style="background: linear-gradient(135deg, #f59e0b, #f97316); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                💰 Phân Tích Chi Phí
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal khi click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Ước tính chi phí sửa chữa
        function getEstimatedRepairCost(severity) {
            const costs = {
                'critical': '1-3 triệu VNĐ',
                'high': '500k-1.5tr VNĐ',
                'medium': '200-800k VNĐ',
                'low': '50-300k VNĐ'
            };
            return costs[severity] || 'Cần báo giá';
        }

        // Ước tính thời gian sửa chữa
        function getEstimatedRepairTime(severity) {
            const times = {
                'critical': '4-8 giờ',
                'high': '2-4 giờ',
                'medium': '1-2 giờ',
                'low': '30-60 phút'
            };
            return times[severity] || 'Cần đánh giá';
        }

        // Độ khó sửa chữa
        function getRepairDifficulty(severity) {
            const difficulties = {
                'critical': 'Rất khó',
                'high': 'Khó',
                'medium': 'Trung bình',
                'low': 'Dễ'
            };
            return difficulties[severity] || 'Không xác định';
        }

        // Hiển thị ước tính chi phí
        function showCostEstimate() {
            const allErrors = analysisResults.flatMap(result => result.errors);
            if (allErrors.length === 0) {
                showNotification('Chưa có lỗi nào để ước tính chi phí', 'warning');
                return;
            }
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 20px;
            `;
            
            // Tính toán chi phí
            const costBreakdown = calculateDetailedCosts(allErrors);
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 25px; max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #f59e0b, #f97316); color: white; padding: 30px; border-radius: 25px 25px 0 0; position: sticky; top: 0; z-index: 1;">
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                            <div>
                                <h2 style="margin: 0 0 10px 0; font-size: 1.8em;">💰 Ước Tính Chi Phí Sửa Chữa</h2>
                                <p style="margin: 0; opacity: 0.9; font-size: 1.1em;">Phân tích chi phí chi tiết cho tất cả lỗi được phát hiện</p>
                            </div>
                            <button onclick="this.closest('[style*=\"position: fixed\"]').remove()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 24px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center;">×</button>
                        </div>
                    </div>
                    
                    <div style="padding: 40px;">
                        <!-- Tổng quan chi phí -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #fee2e2, #fecaca); padding: 25px; border-radius: 20px; text-align: center; border-left: 5px solid #dc2626;">
                                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; color: #dc2626;">${costBreakdown.total.min.toLocaleString()}</div>
                                <div style="color: #991b1b; font-weight: bold;">Chi Phí Tối Thiểu (VNĐ)</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #fed7aa, #fdba74); padding: 25px; border-radius: 20px; text-align: center; border-left: 5px solid #ea580c;">
                                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; color: #ea580c;">${costBreakdown.total.max.toLocaleString()}</div>
                                <div style="color: #9a3412; font-weight: bold;">Chi Phí Tối Đa (VNĐ)</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); padding: 25px; border-radius: 20px; text-align: center; border-left: 5px solid #2563eb;">
                                <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px; color: #2563eb;">${Math.round((costBreakdown.total.min + costBreakdown.total.max) / 2).toLocaleString()}</div>
                                <div style="color: #1e40af; font-weight: bold;">Chi Phí Trung Bình (VNĐ)</div>
                            </div>
                        </div>
                        
                        <!-- Chi phí theo mức độ -->
                        <div style="background: #f8fafc; padding: 25px; border-radius: 20px; margin-bottom: 30px;">
                            <h3 style="color: #2d3748; margin: 0 0 20px 0;">📊 Phân Bổ Chi Phí Theo Mức Độ</h3>
                            <div style="display: grid; gap: 15px;">
                                ${Object.entries(costBreakdown.bySeverity).map(([severity, data]) => `
                                    <div style="background: white; padding: 20px; border-radius: 15px; border-left: 5px solid ${getSeverityColor(severity)};">
                                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                                            <div>
                                                <h4 style="margin: 0 0 5px 0; color: ${getSeverityColor(severity)};">${getSeverityText(severity)}</h4>
                                                <div style="color: #6b7280; font-size: 0.9em;">${data.count} lỗi</div>
                                            </div>
                                            <div style="text-align: right;">
                                                <div style="font-size: 1.3em; font-weight: bold; color: #2d3748; margin-bottom: 5px;">
                                                    ${data.min.toLocaleString()} - ${data.max.toLocaleString()} VNĐ
                                                </div>
                                                <div style="color: #6b7280; font-size: 0.9em;">
                                                    Trung bình: ${Math.round((data.min + data.max) / 2).toLocaleString()} VNĐ
                                                </div>
                                            </div>
                                        </div>
                                        <div style="margin-top: 15px; background: #f1f5f9; border-radius: 10px; height: 8px; overflow: hidden;">
                                            <div style="background: ${getSeverityColor(severity)}; height: 100%; width: ${(data.max / costBreakdown.total.max) * 100}%; transition: width 1s ease; border-radius: 10px;"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        
                        <!-- Chi tiết từng lỗi -->
                        <div style="background: #f8fafc; padding: 25px; border-radius: 20px; margin-bottom: 30px;">
                            <h3 style="color: #2d3748; margin: 0 0 20px 0;">🔧 Chi Phí Chi Tiết Từng Lỗi</h3>
                            <div style="display: grid; gap: 15px;">
                                ${allErrors.map((error, index) => {
                                    const cost = getDetailedCostForError(error);
                                    return `
                                        <div style="background: white; padding: 20px; border-radius: 15px; border-left: 5px solid ${getSeverityColor(error.data.severity)};">
                                            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                                                <div style="flex: 1; min-width: 250px;">
                                                    <h4 style="margin: 0 0 8px 0; color: #2d3748;">${error.data.vietnameseName}</h4>
                                                    <div style="color: #6b7280; font-size: 0.9em; margin-bottom: 10px;">
                                                        Linh kiện: ${error.data.component} | Confidence: ${error.confidence}%
                                                    </div>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                                                        <span style="background: ${getSeverityColor(error.data.severity)}; color: white; padding: 4px 12px; border-radius: 15px; font-size: 0.8em; font-weight: bold;">
                                                            ${getSeverityText(error.data.severity)}
                                                        </span>
                                                        <span style="background: #e5e7eb; color: #374151; padding: 4px 12px; border-radius: 15px; font-size: 0.8em;">
                                                            ${getRepairDifficulty(error.data.severity)}
                                                        </span>
                                                    </div>
                                                </div>
                                                <div style="text-align: right; min-width: 150px;">
                                                    <div style="font-size: 1.2em; font-weight: bold; color: #2d3748; margin-bottom: 5px;">
                                                        ${cost.min.toLocaleString()} - ${cost.max.toLocaleString()}
                                                    </div>
                                                    <div style="color: #6b7280; font-size: 0.85em;">VNĐ</div>
                                                    <div style="margin-top: 8px; font-size: 0.8em; color: #6b7280;">
                                                        Thời gian: ${getEstimatedRepairTime(error.data.severity)}
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
                                                <details style="cursor: pointer;">
                                                    <summary style="font-weight: bold; color: #4b5563; margin-bottom: 10px;">💡 Chi tiết chi phí</summary>
                                                    <div style="background: #f9fafb; padding: 15px; border-radius: 10px; margin-top: 10px;">
                                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; font-size: 0.9em;">
                                                            <div>
                                                                <strong>Linh kiện:</strong><br>
                                                                <span style="color: #6b7280;">${cost.breakdown.parts}</span>
                                                            </div>
                                                            <div>
                                                                <strong>Công sửa chữa:</strong><br>
                                                                <span style="color: #6b7280;">${cost.breakdown.labor}</span>
                                                            </div>
                                                            <div>
                                                                <strong>Chi phí khác:</strong><br>
                                                                <span style="color: #6b7280;">${cost.breakdown.misc}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </details>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Khuyến nghị tiết kiệm -->
                        <div style="background: linear-gradient(135deg, #dcfce7, #bbf7d0); padding: 25px; border-radius: 20px; margin-bottom: 30px; border-left: 5px solid #16a34a;">
                            <h3 style="color: #14532d; margin: 0 0 20px 0; display: flex; align-items: center;">
                                <span style="background: #16a34a; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">💡</span>
                                Khuyến Nghị Tiết Kiệm Chi Phí
                            </h3>
                            <div style="color: #14532d; line-height: 1.7;">
                                ${generateCostSavingTips(allErrors)}
                            </div>
                        </div>
                        
                        <!-- Phương án thanh toán -->
                        <div style="background: #f3f4f6; padding: 25px; border-radius: 20px; margin-bottom: 20px;">
                            <h3 style="color: #374151; margin: 0 0 20px 0;">💳 Phương Án Thanh Toán</h3>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                                <div style="background: white; padding: 20px; border-radius: 15px; border: 2px solid #10b981;">
                                    <h4 style="margin: 0 0 15px 0; color: #047857;">✅ Sửa Tất Cả Ngay</h4>
                                    <div style="font-size: 1.3em; font-weight: bold; color: #047857; margin-bottom: 10px;">
                                        ${Math.round((costBreakdown.total.min + costBreakdown.total.max) / 2).toLocaleString()} VNĐ
                                    </div>
                                    <ul style="margin: 0; padding-left: 20px; color: #065f46; font-size: 0.9em; line-height: 1.6;">
                                        <li>Giải quyết triệt để tất cả vấn đề</li>
                                        <li>Có thể được giảm giá combo</li>
                                        <li>Bảo hành toàn bộ sửa chữa</li>
                                    </ul>
                                </div>
                                
                                <div style="background: white; padding: 20px; border-radius: 15px; border: 2px solid #f59e0b;">
                                    <h4 style="margin: 0 0 15px 0; color: #d97706;">⚡ Ưu Tiên Critical</h4>
                                    <div style="font-size: 1.3em; font-weight: bold; color: #d97706; margin-bottom: 10px;">
                                        ${costBreakdown.bySeverity.critical ? Math.round((costBreakdown.bySeverity.critical.min + costBreakdown.bySeverity.critical.max) / 2).toLocaleString() : '0'} VNĐ
                                    </div>
                                    <ul style="margin: 0; padding-left: 20px; color: #92400e; font-size: 0.9em; line-height: 1.6;">
                                        <li>Sửa lỗi nghiêm trọng trước</li>
                                        <li>Tránh hỏng thêm linh kiện khác</li>
                                        <li>Chi phí thấp nhất ban đầu</li>
                                    </ul>
                                </div>
                                
                                <div style="background: white; padding: 20px; border-radius: 15px; border: 2px solid #6366f1;">
                                    <h4 style="margin: 0 0 15px 0; color: #4f46e5;">📅 Chia Làm Nhiều Đợt</h4>
                                    <div style="font-size: 1.3em; font-weight: bold; color: #4f46e5; margin-bottom: 10px;">
                                        Linh hoạt
                                    </div>
                                    <ul style="margin: 0; padding-left: 20px; color: #3730a3; font-size: 0.9em; line-height: 1.6;">
                                        <li>Chia nhỏ chi phí theo thời gian</li>
                                        <li>Theo dõi hiệu quả từng bước</li>
                                        <li>Dừng khi đủ ổn định</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: center; display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">
                            <button onclick="generateCostReport()" style="background: linear-gradient(135deg, #f59e0b, #f97316); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                📊 Tạo Báo Cáo Chi Phí
                            </button>
                            <button onclick="findNearbyRepairShops()" style="background: linear-gradient(135deg, #10b981, #34d399); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                🗺️ Tìm Cửa Hàng Gần Nhất
                            </button>
                            <button onclick="requestQuote()" style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; transition: transform 0.2s; flex: 1; min-width: 200px; max-width: 250px;">
                                📝 Yêu Cầu Báo Giá
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Close modal khi click outside
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Tính toán chi phí chi tiết
        function calculateDetailedCosts(errors) {
            const costRanges = {
                'critical': { min: 1000000, max: 3000000 },
                'high': { min: 500000, max: 1500000 },
                'medium': { min: 200000, max: 800000 },
                'low': { min: 50000, max: 300000 }
            };
            
            const result = {
                total: { min: 0, max: 0 },
                bySeverity: {}
            };
            
            errors.forEach(error => {
                const severity = error.data.severity;
                const range = costRanges[severity] || { min: 100000, max: 500000 };
                
                result.total.min += range.min;
                result.total.max += range.max;
                
                if (!result.bySeverity[severity]) {
                    result.bySeverity[severity] = { min: 0, max: 0, count: 0 };
                }
                
                result.bySeverity[severity].min += range.min;
                result.bySeverity[severity].max += range.max;
                result.bySeverity[severity].count += 1;
            });
            
            return result;
        }

        // Chi phí chi tiết cho từng lỗi
        function getDetailedCostForError(error) {
            const baseCosts = {
                'critical': { min: 1000000, max: 3000000 },
                'high': { min: 500000, max: 1500000 },
                'medium': { min: 200000, max: 800000 },
                'low': { min: 50000, max: 300000 }
            };
            
            const base = baseCosts[error.data.severity] || { min: 100000, max: 500000 };
            
            return {
                min: base.min,
                max: base.max,
                breakdown: {
                    parts: `${Math.round(base.min * 0.6).toLocaleString()} - ${Math.round(base.max * 0.6).toLocaleString()} VNĐ`,
                    labor: `${Math.round(base.min * 0.3).toLocaleString()} - ${Math.round(base.max * 0.3).toLocaleString()} VNĐ`,
                    misc: `${Math.round(base.min * 0.1).toLocaleString()} - ${Math.round(base.max * 0.1).toLocaleString()} VNĐ`
                }
            };
        }

        // Tạo lời khuyên tiết kiệm chi phí
        function generateCostSavingTips(errors) {
            const criticalCount = errors.filter(e => e.data.severity === 'critical').length;
            const highCount = errors.filter(e => e.data.severity === 'high').length;
            
            let tips = [];
            
            if (criticalCount > 0) {
                tips.push('• <strong>Ưu tiên sửa lỗi Critical trước</strong> để tránh hỏng thêm linh kiện khác, có thể tiết kiệm 20-30% tổng chi phí.');
            }
            
            if (errors.length > 3) {
                tips.push('• <strong>Sửa combo nhiều lỗi cùng lúc</strong> thường được giảm giá 10-15% so với sửa từng cái.');
            }
            
            if (highCount > 1) {
                tips.push('• <strong>Thương lượng giá</strong> khi có nhiều lỗi mức cao, nhiều cửa hàng sẵn sàng giảm giá để có khách hàng lớn.');
            }
            
            tips.push('• <strong>So sánh giá ít nhất 3 cửa hàng</strong> trước khi quyết định, giá có thể chênh lệch 20-40%.');
            tips.push('• <strong>Kiểm tra bảo hành</strong> trước khi sửa - một số lỗi có thể được bảo hành miễn phí.');
            tips.push('• <strong>Cân nhắc mua máy mới</strong> nếu tổng chi phí sửa chữa > 60% giá trị máy hiện tại.');
            
            return tips.join('<br>');
        }

        // Xóa tất cả lịch sử
        function clearAllHistory() {
            if (confirm('Bạn có chắc chắn muốn xóa tất cả lịch sử phân tích? Hành động này không thể hoàn tác.')) {
                analysisResults = [];
                localStorage.removeItem('panicAnalysisHistory');
                localStorage.removeItem('diagnosticProgress');
                
                const container = document.getElementById('resultsContainer');
                container.style.display = 'none';
                
                showNotification('Đã xóa tất cả lịch sử phân tích', 'success');
            }
        }

        // Xuất báo cáo chi tiết
        function exportDetailedReport() {
            if (analysisResults.length === 0) {
                showNotification('Chưa có dữ liệu để xuất báo cáo', 'warning');
                return;
            }
            
            const allErrors = analysisResults.flatMap(result => result.errors);
            const reportDate = new Date().toLocaleString('vi-VN');
            
            const reportContent = `
                <div style="font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 40px; background: white;">
                    <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #667eea; padding-bottom: 20px;">
                        <h1 style="color: #2d3748; margin: 0 0 10px 0;">📊 BÁO CÁO PHÂN TÍCH PANIC LOG TỔNG HỢP</h1>
                        <p style="color: #666; margin: 10px 0 0 0;">Ngày tạo: ${reportDate}</p>
                        <p style="color: #666; margin: 5px 0 0 0;">Tổng số file phân tích: ${analysisResults.length} | Tổng số lỗi: ${allErrors.length}</p>
                    </div>
                    
                    <!-- Executive Summary -->
                    <div style="background: #f8fafc; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                        <h2 style="color: #2d3748; margin: 0 0 20px 0;">📈 Tóm Tắt Điều Hành</h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            ${generateExecutiveSummary(allErrors)}
                        </div>
                    </div>
                    
                    <!-- Detailed Analysis -->
                    <div style="margin-bottom: 30px;">
                        <h2 style="color: #2d3748; margin: 0 0 20px 0;">🔍 Phân Tích Chi Tiết</h2>
                        ${generateDetailedAnalysisReport(analysisResults)}
                    </div>
                    
                    <!-- Recommendations -->
                    <div style="background: #e6fffa; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                        <h2 style="color: #234e52; margin: 0 0 20px 0;">💡 Khuyến Nghị</h2>
                        ${generateRecommendationsReport(allErrors)}
                    </div>
                    
                    <!-- Cost Analysis -->
                    <div style="background: #fff7ed; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                        <h2 style="color: #9a3412; margin: 0 0 20px 0;">💰 Phân Tích Chi Phí</h2>
                        ${generateCostAnalysisReport(allErrors)}
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0;">
                        <p style="color: #666; font-size: 0.9em;">Báo cáo được tạo bởi AI Panic Log Analyzer v2.0</p>
                        <p style="color: #666; font-size: 0.8em;">© 2024 - Công cụ phân tích chuyên nghiệp cho thiết bị Apple</p>
                    </div>
                </div>
            `;
            
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Báo Cáo Phân Tích Panic Log Tổng Hợp</title>
                    <meta charset="UTF-8">
                    <style>
                        @media print {
                            body { margin: 0; }
                            .no-print { display: none; }
                        }
                        @page {
                            margin: 20mm;
                            size: A4;
                        }
                    </style>
                </head>
                <body>
                    ${reportContent}
                    <div class="no-print" style="text-align: center; margin: 20px;">
                        <button onclick="window.print()" style="background: #667eea; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold; margin-right: 15px;">🖨️ In Báo Cáo</button>
                        <button onclick="window.close()" style="background: #e53e3e; color: white; border: none; padding: 15px 30px; border-radius: 25px; cursor: pointer; font-weight: bold;">❌ Đóng</button>
                    </div>
                </body>
                </html>
            `);
            newWindow.document.close();
        }

        // Tạo tóm tắt điều hành
        function generateExecutiveSummary(errors) {
            const severityCount = {
                critical: errors.filter(e => e.data.severity === 'critical').length,
                high: errors.filter(e => e.data.severity === 'high').length,
                medium: errors.filter(e => e.data.severity === 'medium').length,
                low: errors.filter(e => e.data.severity === 'low').length
            };
            
            const totalCost = calculateDetailedCosts(errors);
            const avgCost = Math.round((totalCost.total.min + totalCost.total.max) / 2);
            
            return `
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #dc2626; margin-bottom: 10px;">${severityCount.critical}</div>
                    <div style="color: #991b1b; font-weight: bold;">Lỗi Critical</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #ea580c; margin-bottom: 10px;">${severityCount.high}</div>
                    <div style="color: #9a3412; font-weight: bold;">Lỗi High</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #2563eb; margin-bottom: 10px;">${avgCost.toLocaleString()}</div>
                    <div style="color: #1e40af; font-weight: bold;">Chi Phí TB (VNĐ)</div>
                </div>
                <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                    <div style="font-size: 2em; font-weight: bold; color: #16a34a; margin-bottom: 10px;">${Math.round(errors.reduce((sum, e) => sum + e.confidence, 0) / errors.length)}%</div>
                    <div style="color: #15803d; font-weight: bold;">Độ Tin Cậy TB</div>
                </div>
            `;
        }

        // Tạo báo cáo phân tích chi tiết
        function generateDetailedAnalysisReport(results) {
            return results.map((result, index) => `
                <div style="background: #f8fafc; padding: 25px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid #667eea;">
                    <h3 style="color: #2d3748; margin: 0 0 15px 0;">📄 File ${index + 1}: ${result.fileName}</h3>
                    <div style="color: #4a5568; margin-bottom: 15px; font-size: 0.9em;">
                        Thời gian phân tích: ${new Date(result.timestamp).toLocaleString('vi-VN')}
                    </div>
                    
                    ${result.errors.length > 0 ? `
                        <div style="background: white; padding: 20px; border-radius: 10px;">
                            <h4 style="color: #2d3748; margin: 0 0 15px 0;">🔍 Lỗi được phát hiện:</h4>
                            ${result.errors.map(error => `
                                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid ${getSeverityColor(error.data.severity)};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <strong style="color: #2d3748;">${error.data.vietnameseName}</strong>
                                        <span style="background: ${getSeverityColor(error.data.severity)}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold;">
                                            ${getSeverityText(error.data.severity)}
                                        </span>
                                    </div>
                                    <div style="color: #6b7280; font-size: 0.9em;">
                                        <strong>Linh kiện:</strong> ${error.data.component} | 
                                        <strong>Vị trí:</strong> ${error.data.location} | 
                                        <strong>Confidence:</strong> ${error.confidence}%
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="background: #f0fdf4; padding: 20px; border-radius: 10px; border-left: 3px solid #16a34a;">
                            <div style="color: #15803d; text-align: center;">
                                ✅ Không phát hiện lỗi panic cụ thể trong file này
                            </div>
                        </div>
                    `}
                </div>
            `).join('');
        }

        // Tạo báo cáo khuyến nghị
        function generateRecommendationsReport(errors) {
            if (errors.length === 0) {
                return '<div style="color: #15803d; text-align: center; font-size: 1.1em;">✅ Hệ thống hoạt động ổn định, không cần can thiệp</div>';
            }
            
            const criticalErrors = errors.filter(e => e.data.severity === 'critical');
            const highErrors = errors.filter(e => e.data.severity === 'high');
            
            let recommendations = [];
            
            if (criticalErrors.length > 0) {
                recommendations.push(`
                    <div style="background: #fee2e2; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #dc2626;">
                        <h4 style="color: #991b1b; margin: 0 0 10px 0;">🚨 Hành Động Khẩn Cấp</h4>
                        <ul style="color: #991b1b; margin: 0; padding-left: 20px;">
                            <li>Ngừng sử dụng thiết bị ngay lập tức để tránh hỏng thêm</li>
                            <li>Backup dữ liệu quan trọng nếu thiết bị còn hoạt động được</li>
                            <li>Đưa đến cửa hàng sửa chữa chuyên nghiệp trong 24h</li>
                            <li>Ưu tiên sửa ${criticalErrors.length} lỗi critical trước</li>
                        </ul>
                    </div>
                `);
            }
            
            if (highErrors.length > 0) {
                recommendations.push(`
                    <div style="background: #fed7aa; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #ea580c;">
                        <h4 style="color: #9a3412; margin: 0 0 10px 0;">⚠️ Cần Chú Ý</h4>
                        <ul style="color: #9a3412; margin: 0; padding-left: 20px;">
                            <li>Lên lịch sửa chữa trong vòng 1 tuần</li>
                            <li>Theo dõi triệu chứng có tăng nặng không</li>
                            <li>Tránh sử dụng thiết bị trong điều kiện khắc nghiệt</li>
                            <li>Chuẩn bị phương án backup dữ liệu</li>
                        </ul>
                    </div>
                `);
            }
            
            recommendations.push(`
                <div style="background: #dbeafe; padding: 20px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #2563eb;">
                    <h4 style="color: #1e40af; margin: 0 0 10px 0;">💡 Khuyến Nghị Chung</h4>
                    <ul style="color: #1e40af; margin: 0; padding-left: 20px;">
                        <li>Cập nhật iOS/macOS lên phiên bản mới nhất</li>
                        <li>Thực hiện reset cài đặt nếu chưa thử</li>
                        <li>Kiểm tra bảo hành trước khi sửa chữa</li>
                        <li>Lưu giữ panic logs để theo dõi xu hướng</li>
                        <li>Cân nhắc nâng cấp thiết bị nếu quá cũ</li>
                    </ul>
                </div>
            `);
            
            return recommendations.join('');
        }

        // Tạo báo cáo phân tích chi phí
        function generateCostAnalysisReport(errors) {
            if (errors.length === 0) {
                return '<div style="color: #15803d; text-align: center; font-size: 1.1em;">💰 Không có chi phí sửa chữa</div>';
            }
            
            const costBreakdown = calculateDetailedCosts(errors);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #dc2626; margin-bottom: 10px;">
                            ${costBreakdown.total.min.toLocaleString()}
                        </div>
                        <div style="color: #991b1b; font-weight: bold;">Chi Phí Tối Thiểu (VNĐ)</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #ea580c; margin-bottom: 10px;">
                            ${costBreakdown.total.max.toLocaleString()}
                        </div>
                        <div style="color: #9a3412; font-weight: bold;">Chi Phí Tối Đa (VNĐ)</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.8em; font-weight: bold; color: #2563eb; margin-bottom: 10px;">
                            ${Math.round((costBreakdown.total.min + costBreakdown.total.max) / 2).toLocaleString()}
                        </div>
                        <div style="color: #1e40af; font-weight: bold;">Chi Phí Trung Bình (VNĐ)</div>
                    </div>
                </div>
                
                <div style="background: white; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #2d3748; margin: 0 0 15px 0;">📊 Phân Bổ Chi Phí Theo Mức Độ</h4>
                    ${Object.entries(costBreakdown.bySeverity).map(([severity, data]) => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #e5e7eb;">
                            <div>
                                <span style="background: ${getSeverityColor(severity)}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8em; font-weight: bold; margin-right: 10px;">
                                    ${getSeverityText(severity)}
                                </span>
                                <span style="color: #6b7280;">${data.count} lỗi</span>
                            </div>
                            <div style="font-weight: bold; color: #2d3748;">
                                ${data.min.toLocaleString()} - ${data.max.toLocaleString()} VNĐ
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Utility functions cho các tính năng khác
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            const colors = {
                'success': '#10b981',
                'error': '#ef4444',
                'warning': '#f59e0b',
                'info': '#3b82f6'
            };
            
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; z-index: 10001;
                background: ${colors[type]}; color: white; padding: 15px 25px;
                border-radius: 10px; font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                transform: translateX(100%); transition: transform 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // Khởi tạo khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisHistory();
            
            // Thêm drag & drop cho file input
            const dropZone = document.querySelector('.upload-area');
            const fileInput = document.getElementById('panicLogFile');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight(e) {
                dropZone.style.background = 'linear-gradient(135deg, #e0f2fe, #b3e5fc)';
                dropZone.style.borderColor = '#0288d1';
            }
            
            function unhighlight(e) {
                dropZone.style.background = 'linear-gradient(135deg, #f8fafc, #e2e8f0)';
                dropZone.style.borderColor = '#cbd5e1';
            }
            
            dropZone.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    fileInput.files = files;
                    showNotification('File đã được tải lên thành công!', 'success');
                }
            }
        });

        // Load lịch sử phân tích
        function loadAnalysisHistory() {
            const saved = localStorage.getItem('panicAnalysisHistory');
            if (saved) {
                try {
                    analysisResults = JSON.parse(saved);
                    if (analysisResults.length > 0) {
                        displayResults();
                    }
                } catch (e) {
                    console.error('Error loading analysis history:', e);
                }
            }
        }

        // Save lịch sử phân tích
        function saveAnalysisHistory() {
            try {
                localStorage.setItem('panicAnalysisHistory', JSON.stringify(analysisResults));
            } catch (e) {
                console.error('Error saving analysis history:', e);
                showNotification('Không thể lưu lịch sử phân tích', 'error');
            }
        
        }
    </script>
</body>
</html>




